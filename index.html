<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>הערכת הסטודנטית בלימודים הקליניים</title>

  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root {
      --primary: #1a3a5c;
      --secondary: #2e6da4;
      --accent: #c8973a;
      --success: #2d7a4f;
      --danger: #b03030;
      --bg: #f5f3ef;
      --card: #ffffff;
      --border: #d4cfc8;
      --text: #1c1c1c;
      --muted: #6b6560;
      --hover: #eef4fb;
      --score-bg: #e8f0f8;
      --score-active: #1a3a5c;
      --score-text: #ffffff;
      --fail-bg: #fde8e8;
      --pass-bg: #e8f7ee;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Heebo', sans-serif;
      background: var(--bg);
      color: var(--text);
      direction: rtl;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--primary);
      color: white;
      padding: 28px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 4px solid var(--accent);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(0,0,0,0.3);
    }

    .header-title { font-size: 22px; font-weight: 800; letter-spacing: 0.5px; }
    .header-subtitle { font-size: 12px; opacity: 0.7; margin-top: 3px; }

    .header-logo {
      width: 52px; height: 52px;
      background: var(--accent);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; font-weight: 800; color: white;
    }

    /* Progress */
    .progress-bar {
      background: rgba(255,255,255,0.2);
      height: 4px;
      position: absolute;
      bottom: 0; right: 0; left: 0;
    }
    .progress-fill {
      background: var(--accent);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
    }

    /* Main layout */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 32px 20px 80px;
    }

    /* Cards */
    .card {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

    .card-header {
      background: var(--primary);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-header.section-b { background: #1e5080; }
    .card-header.section-c { background: #1d5538; }
    .card-header.section-d { background: #5c3a1a; }
    .card-header.section-summary { background: #3a1a5c; }

    .card-header-num {
      width: 36px; height: 36px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 800;
      flex-shrink: 0;
    }

    .card-header-title { font-size: 17px; font-weight: 700; }
    .card-header-subtitle { font-size: 12px; opacity: 0.75; margin-top: 2px; }

    .card-body { padding: 24px; }

    /* Info notice */
    .info-box {
      background: #fffbf0;
      border: 1px solid #e8d48a;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #6b5a1c;
      line-height: 1.6;
    }

    /* Form fields */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .form-grid.three { grid-template-columns: 1fr 1fr 1fr; }
    .form-grid.full { grid-template-columns: 1fr; }

    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 13px; font-weight: 600; color: var(--muted); }
    .field input, .field select, .field textarea {
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-family: 'Heebo', sans-serif;
      font-size: 14px;
      color: var(--text);
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
      direction: rtl;
    }
    .field input:focus, .field select:focus, .field textarea:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(46,109,164,0.12);
    }
    .field textarea { min-height: 80px; resize: vertical; }

    /* Pass/Fail selectors */
    .pass-fail-row {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 8px;
      border: 1.5px solid var(--border);
      background: white;
      gap: 16px;
      transition: background 0.2s;
    }
    .pass-fail-row:last-child { margin-bottom: 0; }

    .pass-fail-text {
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
    }
    .pass-fail-num {
      font-weight: 700;
      color: var(--secondary);
      margin-left: 6px;
    }

    .pass-fail-controls {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .pf-btn {
      padding: 6px 16px;
      border-radius: 20px;
      border: 2px solid transparent;
      font-family: 'Heebo', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      background: #f0f0f0;
      color: #666;
    }
    .pf-btn.pass { border-color: #b8e0c8; }
    .pf-btn.pass:hover { background: var(--pass-bg); color: var(--success); }
    .pf-btn.pass.active { background: var(--success); color: white; border-color: var(--success); }
    .pf-btn.fail { border-color: #f0c0c0; }
    .pf-btn.fail:hover { background: var(--fail-bg); color: var(--danger); }
    .pf-btn.fail.active { background: var(--danger); color: white; border-color: var(--danger); }

    .fail-alert {
      background: var(--fail-bg);
      border: 1px solid #e8a0a0;
      border-radius: 8px;
      padding: 10px 16px;
      margin-top: 8px;
      font-size: 13px;
      color: var(--danger);
      font-weight: 600;
      display: none;
    }
    .fail-alert.show { display: block; }

    .fail-banner {
      background: #b03030;
      color: white;
      border-radius: 10px;
      padding: 14px 20px;
      text-align: center;
      font-size: 15px;
      font-weight: 700;
      margin: 12px 0;
      display: none;
    }
    .fail-banner.show { display: block; }

    /* Score table */
    .score-section-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e8eef5;
    }

    .score-legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: #f0f4f8;
      border-radius: 10px;
      align-items: center;
    }
    .legend-label { font-size: 12px; color: var(--muted); font-weight: 600; margin-left: 6px; }
    .score-chip {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      background: var(--score-bg);
      color: var(--primary);
      cursor: default;
    }
    .score-chip.bad { background: #fde8e8; color: #b03030; }
    .score-chip.borderline { background: #fff3cd; color: #856404; }
    .score-chip.good { background: #d4edda; color: #155724; }
    .score-chip.excellent { background: #cce5ff; color: #004085; }
    .score-chip.na { background: #e2e3e5; color: #555; }

    /* Score rows — two-line layout: text on top, buttons on bottom */
    .score-row {
      display: flex;
      flex-direction: column;
      padding: 10px 14px;
      border-radius: 10px;
      margin-bottom: 8px;
      border: 1.5px solid var(--border);
      background: white;
      gap: 8px;
      transition: background 0.2s;
    }
    .score-row.improvement-item { border-color: #f0e0a0; background: #fffef5; }

    .score-row-top {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .score-row-text {
      flex: 1;
      font-size: 13.5px;
      line-height: 1.5;
    }
    .score-row-num {
      font-weight: 700;
      color: var(--secondary);
      font-size: 12px;
      flex-shrink: 0;
      min-width: 20px;
    }

    /* Buttons always in a single row using grid */
    .score-buttons {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      width: 100%;
    }

    .score-btn {
      height: 36px;
      width: 100%;
      border-radius: 7px;
      border: 1.5px solid var(--border);
      font-family: 'Heebo', sans-serif;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      background: white;
      color: var(--text);
      white-space: nowrap;
      padding: 0 2px;
    }
    .score-btn:hover { background: var(--hover); border-color: var(--secondary); }
    .score-btn.score-45 { font-size: 10px; }
    .score-btn.score-99 { font-size: 9.5px; background: #f0f0f0; color: #888; }
    .score-btn.active { background: var(--score-active); color: white; border-color: var(--score-active); }
    .score-btn.active.low { background: var(--danger); border-color: var(--danger); }
    .score-btn.active.borderline { background: #856404; border-color: #856404; }
    .score-btn.active.na { background: #666; border-color: #666; }

    .improvement-note {
      font-size: 11.5px;
      color: #856404;
      background: #fff3cd;
      border-radius: 6px;
      padding: 4px 8px;
      margin-top: 4px;
      display: none;
    }
    .improvement-note.show { display: block; }

    /* Section average */
    .section-average {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: linear-gradient(135deg, #1a3a5c 0%, #2e6da4 100%);
      border-radius: 10px;
      color: white;
      margin-top: 16px;
    }
    .section-average.section-b { background: linear-gradient(135deg, #1e5080 0%, #2e7db4 100%); }
    .section-average.section-c { background: linear-gradient(135deg, #1d5538 0%, #2d7a4f 100%); }
    .section-average.section-d { background: linear-gradient(135deg, #5c3a1a 0%, #8b5e2a 100%); }

    .avg-label { font-size: 14px; font-weight: 600; }
    .avg-value {
      font-size: 28px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .avg-value.fail-score { color: #ffaaaa; }
    .avg-value small { font-size: 14px; font-weight: 400; opacity: 0.8; }

    /* Comments area */
    .comments-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1.5px dashed var(--border);
    }
    .comments-section label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      display: block;
      margin-bottom: 8px;
    }

    /* Final summary */
    .final-score-box {
      background: linear-gradient(135deg, #1a3a5c 0%, #2e3a5c 100%);
      border-radius: 14px;
      padding: 28px;
      color: white;
      text-align: center;
      margin-bottom: 20px;
    }
    .final-score-label { font-size: 16px; font-weight: 500; opacity: 0.85; margin-bottom: 8px; }
    .final-score-value { font-size: 64px; font-weight: 800; line-height: 1; }
    .final-score-value.pass { color: #7de89a; }
    .final-score-value.fail { color: #ff8888; }
    .final-score-status {
      margin-top: 10px;
      font-size: 18px;
      font-weight: 700;
      padding: 6px 20px;
      border-radius: 20px;
      display: inline-block;
    }
    .final-score-status.pass { background: rgba(125,232,154,0.2); color: #7de89a; }
    .final-score-status.fail { background: rgba(255,136,136,0.2); color: #ff8888; }

    .breakdown-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 16px 0;
    }
    .breakdown-item {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }
    .breakdown-item-label { font-size: 11px; opacity: 0.75; margin-bottom: 4px; }
    .breakdown-item-value { font-size: 22px; font-weight: 800; }

    /* Submit button */
    .submit-area {
      padding: 28px;
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }

    .submit-btn {
      background: linear-gradient(135deg, #1a3a5c, #2e6da4);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 40px;
      font-family: 'Heebo', sans-serif;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 16px rgba(26,58,92,0.4);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(26,58,92,0.5);
    }
    .submit-btn:active { transform: translateY(0); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1a3a5c;
      color: white;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 9999;
      max-width: 420px;
      white-space: pre-line;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    /* Spinner */
    .spinner {
      width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 680px) {
      .form-grid { grid-template-columns: 1fr; }
      .form-grid.three { grid-template-columns: 1fr 1fr; }
      .score-buttons { grid-template-columns: repeat(5, 1fr); }
      .breakdown-grid { grid-template-columns: repeat(2, 1fr); }
      .header { padding: 18px 20px; }
      .card-body { padding: 16px; }
    }
  </style>
</head>

<body>
<header class="header">
  <div style="position:relative;">
    <div class="header-title">הערכת הסטודנטית בלימודים הקליניים</div>
    <div class="header-subtitle">ריפוי בעיסוק: טופס הערכה מקצועי</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>
  <div class="header-logo">TAU</div>
</header>

<div class="container">

  <!-- פרטי ההכשרה -->
  <div class="card" id="cardDetails">
    <div class="card-header">
      <div class="card-header-num">פ</div>
      <div>
        <div class="card-header-title">פרטי ההכשרה ופרטי המדריך/ה</div>
        <div class="card-header-subtitle">מלאו את כל הפרטים הנדרשים</div>
      </div>
    </div>
    <div class="card-body">
      <div class="form-grid">
        <div class="field">
          <label>שם הסטודנט/ית</label>
          <input type="text" id="studentName" placeholder="שם מלא">
        </div>
        <div class="field">
          <label>מקום ההכשרה (כולל מקום בארץ)</label>
          <input type="text" id="trainingPlace" placeholder="שם המוסד וישוב">
        </div>
        <div class="field">
          <label>תחום ההכשרה</label>
          <select id="trainingField">
            <option value="">בחרו...</option>
            <option>ילדים</option>
            <option>קהילה</option>
            <option>בריאות הנפש</option>
            <option>פיזיקלי</option>
            <option>גריאטרי</option>
          </select>
        </div>
        <div class="field">
          <label>מעסיק</label>
          <select id="employer">
            <option value="">בחרו...</option>
            <option>אחר</option>
            <option>שירותי בריאות כללית</option>
            <option>מכבי שירותי בריאות</option>
            <option>קופ"ח מאוחדת</option>
            <option>משרד הבריאות</option>
            <option>משרד החינוך</option>
            <option>רווחה</option>
          </select>
        </div>
        <div class="field">
          <label>הכשרה בשנה</label>
          <select id="trainingYear">
            <option value="">בחרו...</option>
            <option>ב</option><option>ג</option><option>ד</option>
          </select>
        </div>
        <div class="field">
          <label>שנה"ל</label>
          <select id="academicYear">
            <option value="">בחרו...</option>
            <option>תשפ"ד</option><option>תשפ"ה</option><option>תשפ"ו</option>
            <option>תשפ"ז</option><option>תשפ"ח</option><option>תשפ"ט</option>
          </select>
        </div>
        <div class="field">
          <label>החל מתאריך</label>
          <input type="date" id="dateFrom">
        </div>
        <div class="field">
          <label>עד תאריך</label>
          <input type="date" id="dateTo">
        </div>
        <div class="field">
          <label>מספר ימי העדרות</label>
          <input type="number" id="absenceDays" min="0" placeholder="0">
        </div>
        <div class="field">
          <label>סיבת ההיעדרות</label>
          <input type="text" id="absenceReason" placeholder="אם רלוונטי">
        </div>
        <div class="field">
          <label>הנושאים בהם התמקד הסטודנט</label>
          <input type="text" id="topics" placeholder="פרטו">
        </div>
        <div class="field">
          <label>קליניקה חוזרת</label>
          <select id="repeatClinic">
            <option value="">בחרו...</option>
            <option>כן</option><option>לא</option>
          </select>
        </div>
      </div>

      <div style="margin-top: 20px; padding-top: 20px; border-top: 1.5px dashed var(--border);">
        <div class="form-grid">
          <div class="field">
            <label>שם המדריך/ה</label>
            <input type="text" id="supervisorName" placeholder="שם מלא">
          </div>
          <div class="field">
            <label>ותק בהדרכה</label>
            <input type="text" id="supervisorExperience" placeholder="שנים">
          </div>
          <div class="field">
            <label>תואר</label>
            <select id="supervisorDegree">
              <option value="">בחרו...</option>
              <option>B.OT</option><option>M.OT</option><option>דוקטורט</option>
            </select>
          </div>
          <div class="field">
            <label>קורס הדרכה</label>
            <select id="supervisorCourse">
              <option value="">בחרו...</option>
              <option>כן</option><option>לא</option>
            </select>
          </div>
          <div class="field">
            <label>היכן נעשה הקורס</label>
            <input type="text" id="coursePlace" placeholder="אם רלוונטי">
          </div>
        </div>
      </div>

      <!-- Staff only fields -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1.5px dashed var(--border);">
        <div style="font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 14px;">⭐ למילוי על-ידי צוות ההדרכה הקלינית</div>
        <div class="form-grid three">
          <div class="field">
            <label>התחיל לימודים בשנה"ל</label>
            <select id="startYear">
              <option value="">בחרו...</option>
              <option>ראשון</option><option>שני</option><option>שלישי</option>
            </select>
          </div>
          <div class="field">
            <label>הגיש בקשה מיוחדת</label>
            <select id="specialRequest">
              <option value="">בחרו...</option>
              <option>כן</option><option>לא</option>
            </select>
          </div>
          <div class="field">
            <label>קיבל בקשה מיוחדת</label>
            <select id="specialRequestApproved">
              <option value="">בחרו...</option>
              <option>כן</option><option>לא</option>
            </select>
          </div>
          <div class="field">
            <label>קיבל ביקור</label>
            <select id="visitReceived">
              <option value="">בחרו...</option>
              <option>כן</option><option>לא</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 2;">
            <label>הערות (צוות הדרכה)</label>
            <input type="text" id="staffNotes" placeholder="הערות">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- הוראות -->
  <div class="info-box">
    <strong>הוראות למילוי:</strong><br>
    • הטופס ימולא בסיום ההתנסות הקלינית, שלא בנוכחות הסטודנטית.<br>
    • יש לנמק החלטות בשורת ההערות (חובה אם הסטודנטית לא עברה או בציון 7 ומטה).<br>
    • <strong>תנאי מעבר:</strong> א. ציון עובר בפרק "התנהגות אישית" + ב. ממוצע כללי 70 לפחות.<br>
    • ציון 6 ומטה = כשלון בהיגד | ציון 7 = תפקוד גבולי | ציון 10 = מצויין בהרבה מעבר לנדרש<br>
    • "לא רלוונטי" — כאשר הסעיף לא נדרש בשלב זה או לא מתאים למסגרת.
  </div>

  <!-- א. התנהגות אישית -->
  <div class="card" id="cardSectionA">
    <div class="card-header">
      <div class="card-header-num">א</div>
      <div>
        <div class="card-header-title">א. התנהגות אישית</div>
        <div class="card-header-subtitle">סטודנטית שלא עברה אחד מהסעיפים 1-6, לא עברה את כל ההתנסות הקלינית</div>
      </div>
    </div>
    <div class="card-body">
      <div id="personalBehaviorItems"></div>
      <div class="fail-banner" id="failBannerA">⚠ הסטודנט/ית נכשל/ה בהכשרה — אין ממשיכים למלא את הציונים</div>
      <div class="comments-section">
        <label>הערות ודוגמאות:</label>
        <textarea id="commentsA" placeholder="נמקו את החלטתכם — חובה אם הסטודנטית נכשלה..."></textarea>
      </div>
    </div>
  </div>

  <!-- ב. יכולות וכישורים -->
  <div class="card" id="cardSectionB">
    <div class="card-header section-b">
      <div class="card-header-num">ב</div>
      <div>
        <div class="card-header-title">ב. יכולות וכישורים הנדרשים לתכנון וביצוע תהליך הטיפול</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionBContent"></div>
    </div>
  </div>

  <!-- ג. תקשורת -->
  <div class="card" id="cardSectionC">
    <div class="card-header section-c">
      <div class="card-header-num">ג</div>
      <div>
        <div class="card-header-title">ג. כישורים כלליים בתקשורת</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionCContent"></div>
    </div>
  </div>

  <!-- ד. אישיות מקצועית -->
  <div class="card" id="cardSectionD">
    <div class="card-header section-d">
      <div class="card-header-num">ד</div>
      <div>
        <div class="card-header-title">ד. גיבוש האישיות המקצועית</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionDContent"></div>
    </div>
  </div>

  <!-- סיכום -->
  <div class="card" id="cardSummary">
    <div class="card-header section-summary">
      <div class="card-header-num">✓</div>
      <div>
        <div class="card-header-title">סיכום התרשמות מהסטודנטית</div>
        <div class="card-header-subtitle">ממולא בסיום ההתנסות הקלינית</div>
      </div>
    </div>
    <div class="card-body">
      <div class="info-box">יש לציין נקודות לשימור ולשיפור. יש להתייחס בצורה מפורשת לסעיפים בהם ניתן ציון 7 ומטה.</div>
      <div class="field">
        <label>סיכום מילולי מפורט:</label>
        <textarea id="finalSummary" placeholder="כתבו סיכום מפורט הכולל נקודות לשימור ולשיפור..." style="min-height: 140px;"></textarea>
      </div>
      <br>
      <div class="final-score-box" id="finalScoreBox">
        <div class="final-score-label">ציון סופי (ממוצע ציונים של כל הטבלאות, מחושב אוטומטית)</div>
        <div class="final-score-value" id="finalScoreDisplay">—</div>
        <div class="final-score-status" id="finalScoreStatus" style="display:none"></div>
        <div class="breakdown-grid">
          <div class="breakdown-item">
            <div class="breakdown-item-label">1. אבחון</div>
            <div class="breakdown-item-value" id="avg1">—</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">2. תכנון</div>
            <div class="breakdown-item-value" id="avg2">—</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">ג. תקשורת</div>
            <div class="breakdown-item-value" id="avg3">—</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">ד. אישיות</div>
            <div class="breakdown-item-value" id="avg4">—</div>
          </div>
        </div>
      </div>
      <div class="form-grid" style="margin-top: 20px;">
        <div class="field">
          <label>תאריך מילוי הערכה סופית</label>
          <input type="date" id="evaluationDate">
        </div>
        <div class="field">
          <label>חתימה / שם המדריך/ה</label>
          <input type="text" id="signatureName" placeholder="שם מלא לאישור">
        </div>
      </div>
    </div>
  </div>

  <!-- Submit -->
  <div class="submit-area">
    <button class="submit-btn" id="submitBtn" onclick="handleSubmitAuto()">
      <span>✓</span>
      אשרי ושמרי ל-Word
    </button>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/**
 * =============================
 * DATA
 * =============================
 */
const personalBehaviorItems = [
  'לוקחת אחריות על מעשיה תוך הכרת גבולות אישיים ומקצועיים',
  'מקבלת משוב ומשנה התנהגות בהתאם',
  'מפגינה התנהגות הולמת בקשריה עם מטופלים, ממונים ואנשי מקצוע אחרים',
  'פועלת תוך שמירה על הקוד האתי וזכויות המטופל',
  'מדווחת על טעויות בכח ובפועל',
  'שומרת על בטיחות המטופל שלה בכל התחומים'
];

const sectionB1Items = [
  'אוספת מידע מקיף ומדויק לגבי הלקוחות על ידי עריכת תצפיות וניתוחן.',
  'אוספת מידע ישיר על ידי ראיון עם הלקוח, בני משפחה ומטפלים נוספים.',
  'אוספת מידע ממקורות כתובים: הפניות, תיק רפואי, ספרות מקצועית',
  'אוספת מידע מהערכות ואבחונים פורמליים',
  'אוספת מידע על תחומי תפקוד רלבנטיים',
  'מזהה עוצמות וחולשות של הלקוחות לפי המידע שבידיה.',
  'מזהה צרכי הלקוח/אדם/אוכלוסיית היעד ומעלה פתרונות אפשריים.',
  'מזהה עוצמות וחולשות של הלקוח/התערבות/הפרוייקט'
];

const sectionB2Items = [
  'קובעת מטרות ללקוח/פרויקט/התערבות מיועדת בהתאם למסקנות שהוסקו מתהליך איסוף המידע המקובל במקום.',
  'קובעת סדרי עדיפויות של מטרות הטיפול/פרויקט/התערבות: לפי צרכי הלקוח ומציאות חייו.',
  'מתאימה שיטות טיפול לצורכי הלקוח/לקוחות: ובהתאם לגישה התיאורטית.',
  'בוחרת פעילויות ואמצעים המתאימים להשגת מטרות הפרויקט/התערבות ומשמעותיים ללקוח.',
  'מזהה מצבים בעייתיים, בוחר ומיישם פתרונות מתאימים.',
  'מתכננת ומשנה תכנית טיפול בהתאם לשלבי ההתקדמות הפרויקט/התערבות',
  'נותנת הסבר ללקוח ומשתפת במהלך ההתערבות',
  'מתכננת ומארגנת את הזמן בהתאם לצרכי הטיפול/התערבות/פרויקט',
  'מכינה את הלקוח/ות לסיום תהליך הטיפול.',
  'מדריכה את הלקוח/ות ומשפחתו בהתאם לצורך.',
  'מתכננת מערך/טיפול התערבות בקהילה.',
  'מפעילה/מבצעת טיפול/התערבות בקהילה.'
];

const sectionCItems = [
  'מקיימת קשר מתאים עם המדריכה: אמון הדדי, פתיחות, שיתוף ברגשות, דעות ומחשבות.',
  'מפתחת קשר טיפולי עם הלקוחות: מכבד, מעורר אמון, מתעניין, מקבל, אמפתי, אסרטיבי, מתייחס לצרכים אינדיבידואליים.',
  'מזהה, מגיבה ומתייחסת לכל צורות התקשורת — תקשורת מילולית ולא מילולית.',
  'מתבטאת בכתב ובע"פ: מדווחת לצוות, מעבירה מידע והנחיות ללקוחות באופן ברור, בהיר ורלבנטי',
  'מקפידה על תיעוד: מתעדת את פעילותה באופן בהיר, שיטתי ומותאם.',
  'נוטלת חלק פעיל בפיתוח תקשורת עם הגורמים המעורבים: מדריכה, צוות ריפוי בעיסוק, צוות רב-מקצועי ומטופלים.',
  'מגלה כבוד, רגישות ופתיחות להבדלים תרבותיים'
];

const sectionDItems = [
  'כושר הסתגלות וגמישות: מסתגלת למסגרת הקהילתית, לאנשי הצוות, לשיטת העבודה, למדריכה.',
  'למידה: לומדת מתצפיות, מהתנסויות וממשוב.',
  'מציגה שאלות מתאימות: שאלות הנוגעות לעיקר, לגישה, לרציונל הטיפולי, בעיתוי המתאים.',
  'מכירה את עוצמותיה/חולשותיה: מודעת לעצמה.',
  'מתמודדת עם מצבי תסכול מקצועיים: קשיים שעולים במהלך ההתערבות/פרוייקט, תסכול מיחסים עם אנשי צוות, מלקוחות.',
  'מגדירה גבולות ברורים בינה לבין הלקוח: התנהגות פיזית ו/או חברתית.',
  'מגלה יוזמה: קריאת חומר, העלאת שאלות, רעיונות והצעות. מגלה נכונות להשתתף בפעילויות.',
  'מגלה יכולת עבודה עצמאית',
  'מתמודדת עם לקוחות בעלי אפיונים שונים ובמצבים משתנים ומשנה התנהגותה בהתאם',
  'מסיימת קשר התערבות: תהליכי פרידה.',
  'שומרת על חוקי המוסר והאתיקה המקצועית: שמירה על סודיות, כיבוד המטופל.',
  'אמינה ואחראית בעבודתה ודיווחיה'
];

const SCORES = [
  { label: '4-5', value: 4.5, cls: 'score-45 low' },
  { label: '6',   value: 6,   cls: 'low' },
  { label: '7',   value: 7,   cls: 'borderline' },
  { label: '7.5', value: 7.5, cls: '' },
  { label: '8',   value: 8,   cls: '' },
  { label: '8.5', value: 8.5, cls: '' },
  { label: '9',   value: 9,   cls: '' },
  { label: '9.5', value: 9.5, cls: '' },
  { label: '10',  value: 10,  cls: '' },
  { label: 'לא רלוונטי', value: 99, cls: 'score-99 na' }
];

const state = {
  personalBehavior: new Array(6).fill(null),
  b1: new Array(sectionB1Items.length).fill(null),
  b2: new Array(sectionB2Items.length).fill(null),
  c: new Array(sectionCItems.length).fill(null),
  d: new Array(sectionDItems.length).fill(null),
};

/**
 * =============================
 * RENDER
 * =============================
 */
function renderPersonalBehavior() {
  const container = document.getElementById('personalBehaviorItems');
  container.innerHTML = personalBehaviorItems.map((item, i) => `
    <div class="pass-fail-row" id="pfRow${i}">
      <div class="pass-fail-text">
        <span class="pass-fail-num">${i+1}.</span>${item}
      </div>
      <div class="pass-fail-controls">
        <button type="button" class="pf-btn pass" onclick="setPersonalBehavior(${i}, 'עבר')">עבר</button>
        <button type="button" class="pf-btn fail" onclick="setPersonalBehavior(${i}, 'נכשל')">נכשל</button>
      </div>
    </div>
    <div class="fail-alert" id="failAlert${i}">הסטודנט/ית נכשל/ה בהכשרה.</div>
  `).join('');
}

function setPersonalBehavior(index, value) {
  state.personalBehavior[index] = value;
  const row = document.getElementById(`pfRow${index}`);
  const alert = document.getElementById(`failAlert${index}`);
  row.querySelectorAll('.pf-btn').forEach(b => b.classList.remove('active'));
  if (value === 'עבר') {
    row.querySelector('.pf-btn.pass').classList.add('active');
    row.style.background = 'var(--pass-bg)';
    alert.classList.remove('show');
  } else {
    row.querySelector('.pf-btn.fail').classList.add('active');
    row.style.background = 'var(--fail-bg)';
    alert.classList.add('show');
  }
  const anyFail = state.personalBehavior.includes('נכשל');
  document.getElementById('failBannerA').classList.toggle('show', anyFail);
  updateAverages();
  updateProgress();
}

function renderScoreSection(containerId, items, sectionKey, sectionTitle, avgId, sectionClass) {
  const container = document.getElementById(containerId);
  const html = `
    <div class="score-section-title">${sectionTitle}</div>
    <div class="score-legend">
      <span class="legend-label">מפתח:</span>
      <span class="score-chip bad">4-5 כשלון</span>
      <span class="score-chip borderline">6 כשלון</span>
      <span class="score-chip borderline">7 גבולי</span>
      <span class="score-chip good">8-9 טוב</span>
      <span class="score-chip excellent">10 מצוין</span>
      <span class="score-chip na">לא רלוונטי</span>
    </div>
    ${items.map((item, i) => `
      <div class="score-row" id="scoreRow_${sectionKey}_${i}">
        <div class="score-row-top">
          <span class="score-row-num">${i+1}.</span>
          <span class="score-row-text">${item}</span>
        </div>
        <div class="improvement-note" id="impNote_${sectionKey}_${i}">⚠ שימי לב שתהיה הלימה בין הציון לבין המשוב המילולי — סעיף זה הוגדר כנקודה לשיפור</div>
        <div class="score-buttons">
          ${SCORES.map(s => `
            <button type="button" class="score-btn ${s.cls}"
              onclick="setScore('${sectionKey}', ${i}, ${s.value}, this)"
              title="${s.label}">${s.label}</button>
          `).join('')}
        </div>
      </div>
    `).join('')}
    <div class="section-average ${sectionClass}">
      <div class="avg-label">ממוצע קטגוריה זו</div>
      <div class="avg-value" id="${avgId}">—<small> / 100</small></div>
    </div>
    <div class="comments-section">
      <label>הערות ודוגמאות:</label>
      <textarea id="comments_${sectionKey}" placeholder="נמקו ציונים נמוכים ותנו דוגמאות..."></textarea>
    </div>
  `;
  container.innerHTML = html;
}

function setScore(sectionKey, index, value, btn) {
  const map = { b1: 'b1', b2: 'b2', c: 'c', d: 'd' };
  state[map[sectionKey]][index] = value;

  const row = document.getElementById(`scoreRow_${sectionKey}_${index}`);
  row.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const note = document.getElementById(`impNote_${sectionKey}_${index}`);
  note.classList.toggle('show', value <= 7 && value !== 99);
  row.classList.toggle('improvement-item', value <= 7 && value !== 99);

  updateAverages();
  updateProgress();
}

function calcAvg(arr) {
  const valid = arr.filter(v => v !== null && v !== 99);
  if (valid.length === 0) return null;
  return valid.reduce((a,b)=>a+b,0) / valid.length * 10; // 0-100
}

function formatAvg(v) {
  if (v === null) return '—';
  return v.toFixed(1);
}

function updateAverages() {
  const a1 = calcAvg(state.b1);
  const a2 = calcAvg(state.b2);
  const a3 = calcAvg(state.c);
  const a4 = calcAvg(state.d);

  document.getElementById('avg_b1').innerHTML = `${formatAvg(a1)}<small> / 100</small>`;
  document.getElementById('avg_b2').innerHTML = `${formatAvg(a2)}<small> / 100</small>`;
  document.getElementById('avg_c').innerHTML  = `${formatAvg(a3)}<small> / 100</small>`;
  document.getElementById('avg_d').innerHTML  = `${formatAvg(a4)}<small> / 100</small>`;

  document.getElementById('avg1').textContent = formatAvg(a1);
  document.getElementById('avg2').textContent = formatAvg(a2);
  document.getElementById('avg3').textContent = formatAvg(a3);
  document.getElementById('avg4').textContent = formatAvg(a4);

  const avgs = [a1, a2, a3, a4].filter(v => v !== null);
  const finalEl = document.getElementById('finalScoreDisplay');
  const statusEl = document.getElementById('finalScoreStatus');

  if (avgs.length === 0) {
    finalEl.textContent = '—';
    statusEl.style.display = 'none';
    finalEl.className = 'final-score-value';
    return;
  }

  const finalAvg = avgs.reduce((a,b)=>a+b,0) / avgs.length;
  finalEl.textContent = finalAvg.toFixed(1);

  const anyPersonalFail = state.personalBehavior.includes('נכשל');
  const passing = !anyPersonalFail && finalAvg >= 70;

  finalEl.className = `final-score-value ${passing ? 'pass' : 'fail'}`;
  statusEl.style.display = 'inline-block';
  statusEl.className = `final-score-status ${passing ? 'pass' : 'fail'}`;
  statusEl.textContent = passing ? '✓ עבר' : '✗ נכשל';
}

/**
 * =============================
 * PROGRESS
 * =============================
 */
function updateProgress() {
  let filled = 0, total = 0;

  total += 6;
  filled += state.personalBehavior.filter(v => v !== null).length;

  [state.b1, state.b2, state.c, state.d].forEach(arr => {
    total += arr.length;
    filled += arr.filter(v => v !== null).length;
  });

  const pct = Math.round((filled / total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
}

/**
 * =============================
 * VALIDATION
 * =============================
 */
function validateForm() {
  const missing = [];

  const unfilledPF = state.personalBehavior.map((v,i) => v === null ? i+1 : null).filter(v => v !== null);
  if (unfilledPF.length > 0) {
    missing.push(`סעיף א - התנהגות אישית: סעיפים ${unfilledPF.join(', ')} לא מולאו`);
  }

  const anyPersonalFail = state.personalBehavior.includes('נכשל');
  if (anyPersonalFail) {
    if (!document.getElementById('commentsA').value.trim()) {
      missing.push('סעיף א - יש למלא הערות ודוגמאות בעת כשלון');
    }
    return missing;
  }

  const sections = [
    { arr: state.b1, name: 'ב.1 אבחון' },
    { arr: state.b2, name: 'ב.2 תכנון' },
    { arr: state.c,  name: 'ג - תקשורת' },
    { arr: state.d,  name: 'ד - אישיות מקצועית' },
  ];

  sections.forEach(sec => {
    const unfilled = sec.arr.map((v,i) => v === null ? i+1 : null).filter(v => v !== null);
    if (unfilled.length > 0) missing.push(`${sec.name}: סעיפים ${unfilled.join(', ')} לא מולאו`);
  });

  if (!document.getElementById('finalSummary').value.trim()) missing.push('סיכום מילולי — שדה ריק');
  if (!document.getElementById('studentName').value.trim()) missing.push('שם הסטודנט/ית — שדה ריק');

  return missing;
}

/**
 * =============================
 * Download helper
 * =============================
 */
function triggerDownload(blob, fileName) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 4500);
}

/**
 * =============================
 * DOCX (Styled) via AltChunk (MHT)
 * =============================
 * הערה חשובה:
 * זה יוצר DOCX שערוך ב-Word, עם עיצוב "דומה לאתר" דרך HTML.
 * Word מייבא את ה-HTML למסמך (AltChunk). לרוב העריכה עובדת מצוין,
 * אבל לפעמים Word "מתרגם" CSS בצורה שונה ממנוע דפדפן.
 */
async function generateStyledDocxFromHtml() {
  const getVal = id => document.getElementById(id)?.value || '';

  const scoreLabel = v => {
    if (v === null) return 'לא מולא';
    if (v === 99) return 'לא רלוונטי';
    return String(v === 4.5 ? '4-5' : v);
  };
  const pfLabel = v => v || 'לא מולא';

  const a1 = calcAvg(state.b1);
  const a2 = calcAvg(state.b2);
  const a3 = calcAvg(state.c);
  const a4 = calcAvg(state.d);
  const avgs = [a1, a2, a3, a4].filter(v => v !== null);
  const finalAvg = avgs.length ? (avgs.reduce((x,y)=>x+y,0) / avgs.length) : null;

  const anyPersonalFail = state.personalBehavior.includes('נכשל');
  const passing = !anyPersonalFail && finalAvg !== null && finalAvg >= 70;

  function esc(s) {
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  // HTML "מעוצב כמו האתר" (בגבולות מה ש-Word אוהב לייבא)
  const html = `<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<style>
  body { font-family: Arial; direction: rtl; color: #1c1c1c; }
  .header { background:#1a3a5c; color:white; padding:18px 22px; border-bottom:4px solid #c8973a; }
  .title { font-size:20px; font-weight:700; }
  .subtitle { font-size:12px; opacity:0.9; margin-top:4px; }

  .card { border:1px solid #d4cfc8; border-radius:12px; margin:14px 0; overflow:hidden; }
  .cardHead { padding:10px 16px; color:white; font-weight:700; }
  .cardBody { padding:14px 16px; }

  .headA { background:#1a3a5c; }
  .headB { background:#1e5080; }
  .headC { background:#1d5538; }
  .headD { background:#5c3a1a; }
  .headS { background:#3a1a5c; }

  table { width:100%; border-collapse:collapse; margin-top:8px; }
  th, td { border:1px solid #e2ded8; padding:8px; vertical-align:top; font-size:12.5px; }
  th { background:#f5f3ef; font-weight:700; }

  .pillPass { display:inline-block; padding:2px 10px; border-radius:999px; background:#2d7a4f; color:white; font-weight:700; font-size:12px; }
  .pillFail { display:inline-block; padding:2px 10px; border-radius:999px; background:#b03030; color:white; font-weight:700; font-size:12px; }

  .note { background:#fffbf0; border:1px solid #e8d48a; padding:10px 12px; border-radius:10px; font-size:12.5px; color:#6b5a1c; }

  .finalBox { background:#1a3a5c; color:white; padding:16px; border-radius:12px; text-align:center; margin-top:10px; }
  .finalScore { font-size:40px; font-weight:800; line-height:1; margin:8px 0; color:${passing ? '#7de89a' : '#ff8888'}; }
  .small { font-size:12px; opacity:0.9; }
</style>
</head>
<body>

<div class="header">
  <div class="title">הערכת הסטודנטית בלימודים הקליניים</div>
  <div class="subtitle">ריפוי בעיסוק: טופס הערכה מקצועי</div>
</div>

<div class="card">
  <div class="cardHead headA">פרטי ההכשרה ופרטי המדריך/ה</div>
  <div class="cardBody">
    <table>
      <tr><th>שדה</th><th>ערך</th></tr>
      <tr><td>שם הסטודנט/ית</td><td>${esc(getVal('studentName'))}</td></tr>
      <tr><td>מקום ההכשרה</td><td>${esc(getVal('trainingPlace'))}</td></tr>
      <tr><td>תחום ההכשרה</td><td>${esc(getVal('trainingField'))}</td></tr>
      <tr><td>מעסיק</td><td>${esc(getVal('employer'))}</td></tr>
      <tr><td>הכשרה בשנה</td><td>${esc(getVal('trainingYear'))}</td></tr>
      <tr><td>שנה"ל</td><td>${esc(getVal('academicYear'))}</td></tr>
      <tr><td>מתאריך</td><td>${esc(getVal('dateFrom'))}</td></tr>
      <tr><td>עד תאריך</td><td>${esc(getVal('dateTo'))}</td></tr>
      <tr><td>ימי העדרות</td><td>${esc(getVal('absenceDays'))}</td></tr>
      <tr><td>סיבת היעדרות</td><td>${esc(getVal('absenceReason'))}</td></tr>
      <tr><td>נושאים</td><td>${esc(getVal('topics'))}</td></tr>
      <tr><td>קליניקה חוזרת</td><td>${esc(getVal('repeatClinic'))}</td></tr>
      <tr><td>שם המדריך/ה</td><td>${esc(getVal('supervisorName'))}</td></tr>
      <tr><td>ותק בהדרכה</td><td>${esc(getVal('supervisorExperience'))}</td></tr>
      <tr><td>תואר</td><td>${esc(getVal('supervisorDegree'))}</td></tr>
      <tr><td>קורס הדרכה</td><td>${esc(getVal('supervisorCourse'))}</td></tr>
      <tr><td>היכן נעשה הקורס</td><td>${esc(getVal('coursePlace'))}</td></tr>
      <tr><td>הערות (צוות הדרכה)</td><td>${esc(getVal('staffNotes'))}</td></tr>
    </table>
  </div>
</div>

<div class="card">
  <div class="cardHead headA">א. התנהגות אישית</div>
  <div class="cardBody">
    <div class="note">סטודנטית שלא עברה אחד מהסעיפים 1-6, לא עברה את כל ההתנסות הקלינית.</div>
    <table>
      <tr><th>#</th><th>היגד</th><th>סטטוס</th></tr>
      ${personalBehaviorItems.map((item,i)=>{
        const v = state.personalBehavior[i];
        const pill = v === 'נכשל' ? '<span class="pillFail">נכשל</span>' :
                     v === 'עבר'  ? '<span class="pillPass">עבר</span>' : esc(pfLabel(v));
        return `<tr><td>${i+1}</td><td>${esc(item)}</td><td>${pill}</td></tr>`;
      }).join('')}
    </table>
    <p><b>הערות:</b> ${esc(getVal('commentsA') || '—')}</p>
  </div>
</div>

<div class="card">
  <div class="cardHead headB">ב.1 אבחון — תהליך איתור הצרכים</div>
  <div class="cardBody">
    <table>
      <tr><th>#</th><th>היגד</th><th>ציון</th></tr>
      ${sectionB1Items.map((item,i)=>`<tr><td>${i+1}</td><td>${esc(item)}</td><td>${esc(scoreLabel(state.b1[i]))}</td></tr>`).join('')}
    </table>
    <p><b>ממוצע:</b> ${a1 === null ? '—' : a1.toFixed(1)} / 100</p>
    ${getVal('comments_b1') ? `<p><b>הערות:</b> ${esc(getVal('comments_b1'))}</p>` : ''}
  </div>
</div>

<div class="card">
  <div class="cardHead headB">ב.2 תכנון הטיפול/פרויקט/התערבות וביצועו</div>
  <div class="cardBody">
    <table>
      <tr><th>#</th><th>היגד</th><th>ציון</th></tr>
      ${sectionB2Items.map((item,i)=>`<tr><td>${i+1}</td><td>${esc(item)}</td><td>${esc(scoreLabel(state.b2[i]))}</td></tr>`).join('')}
    </table>
    <p><b>ממוצע:</b> ${a2 === null ? '—' : a2.toFixed(1)} / 100</p>
    ${getVal('comments_b2') ? `<p><b>הערות:</b> ${esc(getVal('comments_b2'))}</p>` : ''}
  </div>
</div>

<div class="card">
  <div class="cardHead headC">ג. כישורים כלליים בתקשורת</div>
  <div class="cardBody">
    <table>
      <tr><th>#</th><th>היגד</th><th>ציון</th></tr>
      ${sectionCItems.map((item,i)=>`<tr><td>${i+1}</td><td>${esc(item)}</td><td>${esc(scoreLabel(state.c[i]))}</td></tr>`).join('')}
    </table>
    <p><b>ממוצע:</b> ${a3 === null ? '—' : a3.toFixed(1)} / 100</p>
    ${getVal('comments_c') ? `<p><b>הערות:</b> ${esc(getVal('comments_c'))}</p>` : ''}
  </div>
</div>

<div class="card">
  <div class="cardHead headD">ד. גיבוש האישיות המקצועית</div>
  <div class="cardBody">
    <table>
      <tr><th>#</th><th>היגד</th><th>ציון</th></tr>
      ${sectionDItems.map((item,i)=>`<tr><td>${i+1}</td><td>${esc(item)}</td><td>${esc(scoreLabel(state.d[i]))}</td></tr>`).join('')}
    </table>
    <p><b>ממוצע:</b> ${a4 === null ? '—' : a4.toFixed(1)} / 100</p>
    ${getVal('comments_d') ? `<p><b>הערות:</b> ${esc(getVal('comments_d'))}</p>` : ''}
  </div>
</div>

<div class="card">
  <div class="cardHead headS">סיכום התרשמות</div>
  <div class="cardBody">
    <p>${esc(getVal('finalSummary') || '—')}</p>
    <div class="finalBox">
      <div class="small">ציון סופי</div>
      <div class="finalScore">${finalAvg === null ? '—' : finalAvg.toFixed(1)}</div>
      <div>${passing ? '✓ עבר' : '✗ נכשל'}</div>
    </div>
    <p><b>תאריך מילוי:</b> ${esc(getVal('evaluationDate') || '—')}</p>
    <p><b>חתימה:</b> ${esc(getVal('signatureName') || '—')}</p>
  </div>
</div>

</body>
</html>`;

  // MHT (MHTML) ל-AltChunk
  const boundary = "----=_NextPart_000_0000_01D00000.00000000";
  const htmlQP = html
    .replace(/=/g, "=3D")
    .replace(/\r?\n/g, "\r\n");

  const mht =
`MIME-Version: 1.0
Content-Type: multipart/related; boundary="${boundary}"; type="text/html"

--${boundary}
Content-Type: text/html; charset="utf-8"
Content-Transfer-Encoding: quoted-printable

${htmlQP}
--${boundary}--`;

  const documentXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
            xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <w:body>
    <w:altChunk r:id="rId1"/>
    <w:sectPr>
      <w:bidi/>
      <w:pgSz w:w="11906" w:h="16838"/>
      <w:pgMar w:top="720" w:right="720" w:bottom="720" w:left="720"/>
    </w:sectPr>
  </w:body>
</w:document>`;

  const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1"
    Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/aFChunk"
    Target="afchunk.mht"/>
</Relationships>`;

  const appRelsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1"
    Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument"
    Target="word/document.xml"/>
</Relationships>`;

  const contentTypesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Default Extension="mht" ContentType="message/rfc822"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`;

  const zip = new JSZip();
  zip.file('[Content_Types].xml', contentTypesXml);
  zip.file('_rels/.rels', appRelsXml);
  zip.file('word/document.xml', documentXml);
  zip.file('word/afchunk.mht', mht);
  zip.file('word/_rels/document.xml.rels', relsXml);

  return await zip.generateAsync({
    type: 'blob',
    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  });
}

/**
 * =============================
 * SUBMIT: Validate -> Create DOCX -> Download
 * =============================
 */
async function handleSubmitAuto() {
  const errors = validateForm();
  if (errors.length > 0) {
    showToast('⚠️ הטופס אינו מלא:\n' + errors.map(e => '• ' + e).join('\n'), 'error');
    return;
  }

  const btn = document.getElementById('submitBtn');
  const orig = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> יוצר קובץ...';

  try {
    const blob = await generateStyledDocxFromHtml();
    const studentName = (document.getElementById('studentName')?.value || 'הערכה').trim();
    const dateStr = new Date().toLocaleDateString('he-IL').replace(/\//g, '-');
    const fileName = `הערכת_סטודנט_${studentName}_${dateStr}.docx`;

    triggerDownload(blob, fileName);
    showToast(`✅ נשמר קובץ Word בהצלחה!\n${fileName}`, 'success');
  } catch (e) {
    console.error(e);
    showToast('❌ שגיאה ביצירת הקובץ:\n' + (e?.message || e), 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = orig;
  }
}

/**
 * =============================
 * INIT
 * =============================
 */
function init() {
  renderPersonalBehavior();
  const bContainer = document.getElementById('sectionBContent');
  bContainer.innerHTML = `<div id="b1Container" style="margin-bottom: 28px;"></div><div id="b2Container"></div>`;
  renderScoreSection('b1Container', sectionB1Items, 'b1', '1. אבחון — תהליך איתור הצרכים', 'avg_b1', 'section-b');
  renderScoreSection('b2Container', sectionB2Items, 'b2', '2. תכנון הטיפול/פרויקט/התערבות וביצועו', 'avg_b2', 'section-b');
  renderScoreSection('sectionCContent', sectionCItems, 'c', 'כישורים כלליים בתקשורת', 'avg_c', 'section-c');
  renderScoreSection('sectionDContent', sectionDItems, 'd', 'גיבוש האישיות המקצועית', 'avg_d', 'section-d');
  updateAverages();
  updateProgress();
}
init();
</script>

</body>
</html>
