<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>הערכת הסטודנטית בלימודים הקליניים</title>

  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Google Identity Services (OAuth token) -->
  <script src="https://accounts.google.com/gsi/client"></script>

  <style>
    :root {
      --primary: #1a3a5c;
      --secondary: #2e6da4;
      --accent: #c8973a;
      --success: #2d7a4f;
      --danger: #b03030;
      --bg: #f5f3ef;
      --card: #ffffff;
      --border: #d4cfc8;
      --text: #1c1c1c;
      --muted: #6b6560;
      --hover: #eef4fb;
      --score-bg: #e8f0f8;
      --score-active: #1a3a5c;
      --score-text: #ffffff;
      --fail-bg: #fde8e8;
      --pass-bg: #e8f7ee;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Heebo', sans-serif;
      background: var(--bg);
      color: var(--text);
      direction: rtl;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--primary);
      color: white;
      padding: 28px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 4px solid var(--accent);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(0,0,0,0.3);
    }

    .header-title { font-size: 22px; font-weight: 800; letter-spacing: 0.5px; }
    .header-subtitle { font-size: 12px; opacity: 0.7; margin-top: 3px; }

    .header-logo {
      width: 52px; height: 52px;
      background: var(--accent);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; font-weight: 800; color: white;
    }

    /* Progress */
    .progress-bar {
      background: rgba(255,255,255,0.2);
      height: 4px;
      position: absolute;
      bottom: 0; right: 0; left: 0;
    }
    .progress-fill {
      background: var(--accent);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
    }

    /* Main layout */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 32px 20px 80px;
    }

    /* Cards */
    .card {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

    .card-header {
      background: var(--primary);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-header.section-b { background: #1e5080; }
    .card-header.section-c { background: #1d5538; }
    .card-header.section-d { background: #5c3a1a; }
    .card-header.section-summary { background: #3a1a5c; }

    .card-header-num {
      width: 36px; height: 36px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 800;
      flex-shrink: 0;
    }

    .card-header-title { font-size: 17px; font-weight: 700; }
    .card-header-subtitle { font-size: 12px; opacity: 0.75; margin-top: 2px; }

    .card-body { padding: 24px; }

    /* Info notice */
    .info-box {
      background: #fffbf0;
      border: 1px solid #e8d48a;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #6b5a1c;
      line-height: 1.6;
    }

    /* Form fields */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .form-grid.three { grid-template-columns: 1fr 1fr 1fr; }
    .form-grid.full { grid-template-columns: 1fr; }

    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 13px; font-weight: 600; color: var(--muted); }
    .field input, .field select, .field textarea {
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-family: 'Heebo', sans-serif;
      font-size: 14px;
      color: var(--text);
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
      direction: rtl;
    }
    .field input:focus, .field select:focus, .field textarea:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(46,109,164,0.12);
    }
    .field textarea { min-height: 80px; resize: vertical; }

    /* Pass/Fail selectors */
    .pass-fail-row {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 8px;
      border: 1.5px solid var(--border);
      background: white;
      gap: 16px;
      transition: background 0.2s;
    }
    .pass-fail-row:last-child { margin-bottom: 0; }

    .pass-fail-text {
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
    }
    .pass-fail-num {
      font-weight: 700;
      color: var(--secondary);
      margin-left: 6px;
    }

    .pass-fail-controls {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .pf-btn {
      padding: 6px 16px;
      border-radius: 20px;
      border: 2px solid transparent;
      font-family: 'Heebo', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      background: #f0f0f0;
      color: #666;
    }
    .pf-btn.pass { border-color: #b8e0c8; }
    .pf-btn.pass:hover { background: var(--pass-bg); color: var(--success); }
    .pf-btn.pass.active { background: var(--success); color: white; border-color: var(--success); }
    .pf-btn.fail { border-color: #f0c0c0; }
    .pf-btn.fail:hover { background: var(--fail-bg); color: var(--danger); }
    .pf-btn.fail.active { background: var(--danger); color: white; border-color: var(--danger); }

    .fail-alert {
      background: var(--fail-bg);
      border: 1px solid #e8a0a0;
      border-radius: 8px;
      padding: 10px 16px;
      margin-top: 8px;
      font-size: 13px;
      color: var(--danger);
      font-weight: 600;
      display: none;
    }
    .fail-alert.show { display: block; }

    .fail-banner {
      background: #b03030;
      color: white;
      border-radius: 10px;
      padding: 14px 20px;
      text-align: center;
      font-size: 15px;
      font-weight: 700;
      margin: 12px 0;
      display: none;
    }
    .fail-banner.show { display: block; }

    /* Score table */
    .score-section-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e8eef5;
    }

    .score-legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: #f0f4f8;
      border-radius: 10px;
      align-items: center;
    }
    .legend-label { font-size: 12px; color: var(--muted); font-weight: 600; margin-left: 6px; }
    .score-chip {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      background: var(--score-bg);
      color: var(--primary);
      cursor: default;
    }
    .score-chip.bad { background: #fde8e8; color: #b03030; }
    .score-chip.borderline { background: #fff3cd; color: #856404; }
    .score-chip.good { background: #d4edda; color: #155724; }
    .score-chip.excellent { background: #cce5ff; color: #004085; }
    .score-chip.na { background: #e2e3e5; color: #555; }

    /* Score rows — two-line layout: text on top, buttons on bottom */
    .score-row {
      display: flex;
      flex-direction: column;
      padding: 10px 14px;
      border-radius: 10px;
      margin-bottom: 8px;
      border: 1.5px solid var(--border);
      background: white;
      gap: 8px;
      transition: background 0.2s;
    }
    .score-row.improvement-item { border-color: #f0e0a0; background: #fffef5; }

    .score-row-top {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .score-row-text {
      flex: 1;
      font-size: 13.5px;
      line-height: 1.5;
    }
    .score-row-num {
      font-weight: 700;
      color: var(--secondary);
      font-size: 12px;
      flex-shrink: 0;
      min-width: 20px;
    }

    /* Buttons always in a single row using grid */
    .score-buttons {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      width: 100%;
    }

    .score-btn {
      height: 36px;
      width: 100%;
      border-radius: 7px;
      border: 1.5px solid var(--border);
      font-family: 'Heebo', sans-serif;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      background: white;
      color: var(--text);
      white-space: nowrap;
      padding: 0 2px;
    }
    .score-btn:hover { background: var(--hover); border-color: var(--secondary); }
    .score-btn.score-45 { font-size: 10px; }
    .score-btn.score-99 { font-size: 9.5px; background: #f0f0f0; color: #888; }
    .score-btn.active { background: var(--score-active); color: white; border-color: var(--score-active); }
    .score-btn.active.low { background: var(--danger); border-color: var(--danger); }
    .score-btn.active.borderline { background: #856404; border-color: #856404; }
    .score-btn.active.na { background: #666; border-color: #666; }

    .improvement-note {
      font-size: 11.5px;
      color: #856404;
      background: #fff3cd;
      border-radius: 6px;
      padding: 4px 8px;
      margin-top: 4px;
      display: none;
    }
    .improvement-note.show { display: block; }

    /* Section average */
    .section-average {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: linear-gradient(135deg, #1a3a5c 0%, #2e6da4 100%);
      border-radius: 10px;
      color: white;
      margin-top: 16px;
    }
    .section-average.section-b { background: linear-gradient(135deg, #1e5080 0%, #2e7db4 100%); }
    .section-average.section-c { background: linear-gradient(135deg, #1d5538 0%, #2d7a4f 100%); }
    .section-average.section-d { background: linear-gradient(135deg, #5c3a1a 0%, #8b5e2a 100%); }

    .avg-label { font-size: 14px; font-weight: 600; }
    .avg-value {
      font-size: 28px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .avg-value.fail-score { color: #ffaaaa; }
    .avg-value small { font-size: 14px; font-weight: 400; opacity: 0.8; }

    /* Comments area */
    .comments-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1.5px dashed var(--border);
    }
    .comments-section label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      display: block;
      margin-bottom: 8px;
    }

    /* Final summary */
    .final-score-box {
      background: linear-gradient(135deg, #1a3a5c 0%, #2e3a5c 100%);
      border-radius: 14px;
      padding: 28px;
      color: white;
      text-align: center;
      margin-bottom: 20px;
    }
    .final-score-label { font-size: 16px; font-weight: 500; opacity: 0.85; margin-bottom: 8px; }
    .final-score-value { font-size: 64px; font-weight: 800; line-height: 1; }
    .final-score-value.pass { color: #7de89a; }
    .final-score-value.fail { color: #ff8888; }
    .final-score-status {
      margin-top: 10px;
      font-size: 18px;
      font-weight: 700;
      padding: 6px 20px;
      border-radius: 20px;
      display: inline-block;
    }
    .final-score-status.pass { background: rgba(125,232,154,0.2); color: #7de89a; }
    .final-score-status.fail { background: rgba(255,136,136,0.2); color: #ff8888; }

    .breakdown-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 16px 0;
    }
    .breakdown-item {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }
    .breakdown-item-label { font-size: 11px; opacity: 0.75; margin-bottom: 4px; }
    .breakdown-item-value { font-size: 22px; font-weight: 800; }

    /* Submit button */
    .submit-area {
      padding: 28px;
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }

    .submit-btn {
      background: linear-gradient(135deg, #1a3a5c, #2e6da4);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 40px;
      font-family: 'Heebo', sans-serif;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 16px rgba(26,58,92,0.4);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(26,58,92,0.5);
    }
    .submit-btn:active { transform: translateY(0); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .submit-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.6;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1a3a5c;
      color: white;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 9999;
      max-width: 420px;
      white-space: pre-line;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    /* Spinner */
    .spinner {
      width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 680px) {
      .form-grid { grid-template-columns: 1fr; }
      .form-grid.three { grid-template-columns: 1fr 1fr; }
      .score-buttons { grid-template-columns: repeat(5, 1fr); }
      .breakdown-grid { grid-template-columns: repeat(2, 1fr); }
      .header { padding: 18px 20px; }
      .card-body { padding: 16px; }
    }
  </style>
</head>

<body>

<header class="header">
  <div style="position:relative;">
    <div class="header-title">הערכת הסטודנטית בלימודים הקליניים</div>
    <div class="header-subtitle">ריפוי בעיסוק: טופס הערכה מקצועי</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>
  <div class="header-logo">TAU</div>
</header>

<div class="container">

  <!-- פרטי ההכשרה -->
  <div class="card" id="cardDetails">
    <div class="card-header">
      <div class="card-header-num">פ</div>
      <div>
        <div class="card-header-title">פרטי ההכשרה ופרטי המדריך/ה</div>
        <div class="card-header-subtitle">מלאו את כל הפרטים הנדרשים</div>
      </div>
    </div>
    <div class="card-body">
      <div class="form-grid">
        <div class="field">
          <label>שם הסטודנט/ית</label>
          <input type="text" id="studentName" placeholder="שם מלא">
        </div>
        <div class="field">
          <label>מקום ההכשרה (כולל מקום בארץ)</label>
          <input type="text" id="trainingPlace" placeholder="שם המוסד וישוב">
        </div>
        <div class="field">
          <label>תחום ההכשרה</label>
          <select id="trainingField">
            <option value="">בחרו...</option>
            <option>ילדים</option>
            <option>קהילה</option>
            <option>בריאות הנפש</option>
            <option>פיזיקלי</option>
            <option>גריאטרי</option>
          </select>
        </div>
        <div class="field">
          <label>מעסיק</label>
          <select id="employer">
            <option value="">בחרו...</option>
            <option>אחר</option>
            <option>שירותי בריאות כללית</option>
            <option>מכבי שירותי בריאות</option>
            <option>קופ"ח מאוחדת</option>
            <option>משרד הבריאות</option>
            <option>משרד החינוך</option>
            <option>רווחה</option>
          </select>
        </div>
        <div class="field">
          <label>הכשרה בשנה</label>
          <select id="trainingYear">
            <option value="">בחרו...</option>
            <option>ב</option><option>ג</option><option>ד</option>
          </select>
        </div>
        <div class="field">
          <label>שנה"ל</label>
          <select id="academicYear">
            <option value="">בחרו...</option>
            <option>תשפ"ד</option><option>תשפ"ה</option><option>תשפ"ו</option>
            <option>תשפ"ז</option><option>תשפ"ח</option><option>תשפ"ט</option>
          </select>
        </div>
        <div class="field">
          <label>החל מתאריך</label>
          <input type="date" id="dateFrom">
        </div>
        <div class="field">
          <label>עד תאריך</label>
          <input type="date" id="dateTo">
        </div>
        <div class="field">
          <label>מספר ימי העדרות</label>
          <input type="number" id="absenceDays" min="0" placeholder="0">
        </div>
        <div class="field">
          <label>סיבת ההיעדרות</label>
          <input type="text" id="absenceReason" placeholder="אם רלוונטי">
        </div>
        <div class="field">
          <label>הנושאים בהם התמקד הסטודנט</label>
          <input type="text" id="topics" placeholder="פרטו">
        </div>
        <div class="field">
          <label>קליניקה חוזרת</label>
          <select id="repeatClinic">
            <option value="">בחרו...</option>
            <option>כן</option><option>לא</option>
          </select>
        </div>
      </div>

      <div style="margin-top: 20px; padding-top: 20px; border-top: 1.5px dashed var(--border);">
        <div class="form-grid">
          <div class="field">
            <label>שם המדריך/ה</label>
            <input type="text" id="supervisorName" placeholder="שם מלא">
          </div>
          <div class="field">
            <label>ותק בהדרכה</label>
            <input type="text" id="supervisorExperience" placeholder="שנים">
          </div>
          <div class="field">
            <label>תואר</label>
            <select id="supervisorDegree">
              <option value="">בחרו...</option>
              <option>B.OT</option><option>M.OT</option><option>דוקטורט</option>
            </select>
          </div>
          <div class="field">
            <label>קורס הדרכה</label>
            <select id="supervisorCourse">
              <option value="">בחרו...</option>
              <option>כן</option><option>לא</option>
            </select>
          </div>
          <div class="field">
            <label>היכן נעשה הקורס</label>
            <input type="text" id="coursePlace" placeholder="אם רלוונטי">
          </div>
        </div>
      </div>

      <!-- Staff only fields -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1.5px dashed var(--border);">
        <div style="font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 14px;">⭐ למילוי על-ידי צוות ההדרכה הקלינית</div>
        <div class="form-grid three">
          <div class="field">
            <label>התחיל לימודים בשנה"ל</label>
            <select id="startYear">
              <option value="">בחרו...</option>
              <option>ראשון</option><option>שני</option><option>שלישי</option>
            </select>
          </div>
          <div class="field">
            <label>הגיש בקשה מיוחדת</label>
            <select id="specialRequest">
              <option value="">בחרו...</option>
              <option>כן</option><option>לא</option>
            </select>
          </div>
          <div class="field">
            <label>קיבל בקשה מיוחדת</label>
            <select id="specialRequestApproved">
              <option value="">בחרו...</option>
              <option>כן</option><option>לא</option>
            </select>
          </div>
          <div class="field">
            <label>קיבל ביקור</label>
            <select id="visitReceived">
              <option value="">בחרו...</option>
              <option>כן</option><option>לא</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 2;">
            <label>הערות (צוות הדרכה)</label>
            <input type="text" id="staffNotes" placeholder="הערות">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- הוראות -->
  <div class="info-box">
    <strong>הוראות למילוי:</strong><br>
    • הטופס ימולא בסיום ההתנסות הקלינית, שלא בנוכחות הסטודנטית.<br>
    • יש לנמק החלטות בשורת ההערות (חובה אם הסטודנטית לא עברה או בציון 7 ומטה).<br>
    • <strong>תנאי מעבר:</strong> א. ציון עובר בפרק "התנהגות אישית" + ב. ממוצע כללי 70 לפחות.<br>
    • ציון 6 ומטה = כשלון בהיגד | ציון 7 = תפקוד גבולי | ציון 10 = מצויין בהרבה מעבר לנדרש<br>
    • "לא רלוונטי" — כאשר הסעיף לא נדרש בשלב זה או לא מתאים למסגרת.
  </div>

  <!-- א. התנהגות אישית -->
  <div class="card" id="cardSectionA">
    <div class="card-header">
      <div class="card-header-num">א</div>
      <div>
        <div class="card-header-title">א. התנהגות אישית</div>
        <div class="card-header-subtitle">סטודנטית שלא עברה אחד מהסעיפים 1-6, לא עברה את כל ההתנסות הקלינית</div>
      </div>
    </div>
    <div class="card-body">
      <div id="personalBehaviorItems"></div>
      <div class="fail-banner" id="failBannerA">⚠ הסטודנט/ית נכשל/ה בהכשרה — אין ממשיכים למלא את הציונים</div>
      <div class="comments-section">
        <label>הערות ודוגמאות:</label>
        <textarea id="commentsA" placeholder="נמקו את החלטתכם — חובה אם הסטודנטית נכשלה..."></textarea>
      </div>
    </div>
  </div>

  <!-- ב. יכולות וכישורים -->
  <div class="card" id="cardSectionB">
    <div class="card-header section-b">
      <div class="card-header-num">ב</div>
      <div>
        <div class="card-header-title">ב. יכולות וכישורים הנדרשים לתכנון וביצוע תהליך הטיפול</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionBContent"></div>
    </div>
  </div>

  <!-- ג. תקשורת -->
  <div class="card" id="cardSectionC">
    <div class="card-header section-c">
      <div class="card-header-num">ג</div>
      <div>
        <div class="card-header-title">ג. כישורים כלליים בתקשורת</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionCContent"></div>
    </div>
  </div>

  <!-- ד. אישיות מקצועית -->
  <div class="card" id="cardSectionD">
    <div class="card-header section-d">
      <div class="card-header-num">ד</div>
      <div>
        <div class="card-header-title">ד. גיבוש האישיות המקצועית</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionDContent"></div>
    </div>
  </div>

  <!-- סיכום -->
  <div class="card" id="cardSummary">
    <div class="card-header section-summary">
      <div class="card-header-num">✓</div>
      <div>
        <div class="card-header-title">סיכום התרשמות מהסטודנטית</div>
        <div class="card-header-subtitle">ממולא בסיום ההתנסות הקלינית</div>
      </div>
    </div>
    <div class="card-body">
      <div class="info-box">יש לציין נקודות לשימור ולשיפור. יש להתייחס בצורה מפורשת לסעיפים בהם ניתן ציון 7 ומטה.</div>
      <div class="field">
        <label>סיכום מילולי מפורט:</label>
        <textarea id="finalSummary" placeholder="כתבו סיכום מפורט הכולל נקודות לשימור ולשיפור..." style="min-height: 140px;"></textarea>
      </div>
      <br>
      <div class="final-score-box" id="finalScoreBox">
        <div class="final-score-label">ציון סופי (ממוצע ציונים של כל הטבלאות, מחושב אוטומטית)</div>
        <div class="final-score-value" id="finalScoreDisplay">—</div>
        <div class="final-score-status" id="finalScoreStatus" style="display:none"></div>
        <div class="breakdown-grid">
          <div class="breakdown-item">
            <div class="breakdown-item-label">1. אבחון</div>
            <div class="breakdown-item-value" id="avg1">—</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">2. תכנון</div>
            <div class="breakdown-item-value" id="avg2">—</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">ג. תקשורת</div>
            <div class="breakdown-item-value" id="avg3">—</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">ד. אישיות</div>
            <div class="breakdown-item-value" id="avg4">—</div>
          </div>
        </div>
      </div>
      <div class="form-grid" style="margin-top: 20px;">
        <div class="field">
          <label>תאריך מילוי הערכה סופית</label>
          <input type="date" id="evaluationDate">
        </div>
        <div class="field">
          <label>חתימה / שם המדריך/ה</label>
          <input type="text" id="signatureName" placeholder="שם מלא לאישור">
        </div>
      </div>
    </div>
  </div>

  <!-- Submit -->
  <div class="submit-area">
    <button class="submit-btn" id="submitBtn" onclick="handleSubmitAuto()">
      <span>✓</span>
      אשרי ושלחי
    </button>
    <div class="submit-note">
      בלחיצה אחת: הקובץ יירד למחשב + יועלה אוטומטית ל-Google Drive (לתיקייה שסיפקת).<br>
      חשוב: כדי שהעלאה תעבוד, צריך להגדיר GOOGLE_CLIENT_ID (OAuth) ולהיות עם הרשאת עריכה לתיקייה.
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/**
 * =============================
 * 1) הגדרות DRIVE
 * =============================
 * התיקייה מהלינק שנתת:
 * https://drive.google.com/drive/folders/1q4AAPIBPvcFs6Iy0ahivibCB-uIuoBZ3?usp=sharing
 */
const DRIVE_FOLDER_ID = '1q4AAPIBPvcFs6Iy0ahivibCB-uIuoBZ3';

/**
 * חובה: ליצור OAuth Client ID (Web) בגוגל קלאוד ולהדביק כאן:
 * דוגמה: '1234567890-abc123def456.apps.googleusercontent.com'
 */
const GOOGLE_CLIENT_ID = 'PASTE_YOUR_OAUTH_WEB_CLIENT_ID_HERE.apps.googleusercontent.com';

/**
 * הערה חשובה:
 * "לינק שיתוף" לא מבטיח הרשאת העלאה. כדי שהקובץ באמת יעלה לתיקייה—
 * המשתמש שמתחבר ב-OAuth חייב להיות עם הרשאת "Editor" לתיקייה הזו.
 */


/**
 * =============================
 * DATA
 * =============================
 */
const personalBehaviorItems = [
  'לוקחת אחריות על מעשיה תוך הכרת גבולות אישיים ומקצועיים',
  'מקבלת משוב ומשנה התנהגות בהתאם',
  'מפגינה התנהגות הולמת בקשריה עם מטופלים, ממונים ואנשי מקצוע אחרים',
  'פועלת תוך שמירה על הקוד האתי וזכויות המטופל',
  'מדווחת על טעויות בכח ובפועל',
  'שומרת על בטיחות המטופל שלה בכל התחומים'
];

const sectionB1Items = [
  'אוספת מידע מקיף ומדויק לגבי הלקוחות על ידי עריכת תצפיות וניתוחן.',
  'אוספת מידע ישיר על ידי ראיון עם הלקוח, בני משפחה ומטפלים נוספים.',
  'אוספת מידע ממקורות כתובים: הפניות, תיק רפואי, ספרות מקצועית',
  'אוספת מידע מהערכות ואבחונים פורמליים',
  'אוספת מידע על תחומי תפקוד רלבנטיים',
  'מזהה עוצמות וחולשות של הלקוחות לפי המידע שבידיה.',
  'מזהה צרכי הלקוח/אדם/אוכלוסיית היעד ומעלה פתרונות אפשריים.',
  'מזהה עוצמות וחולשות של הלקוח/התערבות/הפרוייקט'
];

const sectionB2Items = [
  'קובעת מטרות ללקוח/פרויקט/התערבות מיועדת בהתאם למסקנות שהוסקו מתהליך איסוף המידע המקובל במקום.',
  'קובעת סדרי עדיפויות של מטרות הטיפול/פרויקט/התערבות: לפי צרכי הלקוח ומציאות חייו.',
  'מתאימה שיטות טיפול לצורכי הלקוח/לקוחות: ובהתאם לגישה התיאורטית.',
  'בוחרת פעילויות ואמצעים המתאימים להשגת מטרות הפרויקט/התערבות ומשמעותיים ללקוח.',
  'מזהה מצבים בעייתיים, בוחר ומיישם פתרונות מתאימים.',
  'מתכננת ומשנה תכנית טיפול בהתאם לשלבי ההתקדמות הפרויקט/התערבות',
  'נותנת הסבר ללקוח ומשתפת במהלך ההתערבות',
  'מתכננת ומארגנת את הזמן בהתאם לצרכי הטיפול/התערבות/פרויקט',
  'מכינה את הלקוח/ות לסיום תהליך הטיפול.',
  'מדריכה את הלקוח/ות ומשפחתו בהתאם לצורך.',
  'מתכננת מערך/טיפול התערבות בקהילה.',
  'מפעילה/מבצעת טיפול/התערבות בקהילה.'
];

const sectionCItems = [
  'מקיימת קשר מתאים עם המדריכה: אמון הדדי, פתיחות, שיתוף ברגשות, דעות ומחשבות.',
  'מפתחת קשר טיפולי עם הלקוחות: מכבד, מעורר אמון, מתעניין, מקבל, אמפתי, אסרטיבי, מתייחס לצרכים אינדיבידואליים.',
  'מזהה, מגיבה ומתייחסת לכל צורות התקשורת — תקשורת מילולית ולא מילולית.',
  'מתבטאת בכתב ובע"פ: מדווחת לצוות, מעבירה מידע והנחיות ללקוחות באופן ברור, בהיר ורלבנטי',
  'מקפידה על תיעוד: מתעדת את פעילותה באופן בהיר, שיטתי ומותאם.',
  'נוטלת חלק פעיל בפיתוח תקשורת עם הגורמים המעורבים: מדריכה, צוות ריפוי בעיסוק, צוות רב-מקצועי ומטופלים.',
  'מגלה כבוד, רגישות ופתיחות להבדלים תרבותיים'
];

const sectionDItems = [
  'כושר הסתגלות וגמישות: מסתגלת למסגרת הקהילתית, לאנשי הצוות, לשיטת העבודה, למדריכה.',
  'למידה: לומדת מתצפיות, מהתנסויות וממשוב.',
  'מציגה שאלות מתאימות: שאלות הנוגעות לעיקר, לגישה, לרציונל הטיפולי, בעיתוי המתאים.',
  'מכירה את עוצמותיה/חולשותיה: מודעת לעצמה.',
  'מתמודדת עם מצבי תסכול מקצועיים: קשיים שעולים במהלך ההתערבות/פרוייקט, תסכול מיחסים עם אנשי צוות, מלקוחות.',
  'מגדירה גבולות ברורים בינה לבין הלקוח: התנהגות פיזית ו/או חברתית.',
  'מגלה יוזמה: קריאת חומר, העלאת שאלות, רעיונות והצעות. מגלה נכונות להשתתף בפעילויות.',
  'מגלה יכולת עבודה עצמאית',
  'מתמודדת עם לקוחות בעלי אפיונים שונים ובמצבים משתנים ומשנה התנהגותה בהתאם',
  'מסיימת קשר התערבות: תהליכי פרידה.',
  'שומרת על חוקי המוסר והאתיקה המקצועית: שמירה על סודיות, כיבוד המטופל.',
  'אמינה ואחראית בעבודתה ודיווחיה'
];

const SCORES = [
  { label: '4-5', value: 4.5, cls: 'score-45 low' },
  { label: '6',   value: 6,   cls: 'low' },
  { label: '7',   value: 7,   cls: 'borderline' },
  { label: '7.5', value: 7.5, cls: '' },
  { label: '8',   value: 8,   cls: '' },
  { label: '8.5', value: 8.5, cls: '' },
  { label: '9',   value: 9,   cls: '' },
  { label: '9.5', value: 9.5, cls: '' },
  { label: '10',  value: 10,  cls: '' },
  { label: 'לא רלוונטי', value: 99, cls: 'score-99 na' }
];

const state = {
  personalBehavior: new Array(6).fill(null),
  b1: new Array(sectionB1Items.length).fill(null),
  b2: new Array(sectionB2Items.length).fill(null),
  c: new Array(sectionCItems.length).fill(null),
  d: new Array(sectionDItems.length).fill(null),
};

/**
 * =============================
 * RENDER
 * =============================
 */
function renderPersonalBehavior() {
  const container = document.getElementById('personalBehaviorItems');
  container.innerHTML = personalBehaviorItems.map((item, i) => `
    <div class="pass-fail-row" id="pfRow${i}">
      <div class="pass-fail-text">
        <span class="pass-fail-num">${i+1}.</span>${item}
      </div>
      <div class="pass-fail-controls">
        <button class="pf-btn pass" onclick="setPersonalBehavior(${i}, 'עבר')">עבר</button>
        <button class="pf-btn fail" onclick="setPersonalBehavior(${i}, 'נכשל')">נכשל</button>
      </div>
    </div>
    <div class="fail-alert" id="failAlert${i}">הסטודנט/ית נכשל/ה בהכשרה.</div>
  `).join('');
}

function setPersonalBehavior(index, value) {
  state.personalBehavior[index] = value;
  const row = document.getElementById(`pfRow${index}`);
  const alert = document.getElementById(`failAlert${index}`);
  row.querySelectorAll('.pf-btn').forEach(b => b.classList.remove('active'));
  if (value === 'עבר') {
    row.querySelector('.pf-btn.pass').classList.add('active');
    row.style.background = 'var(--pass-bg)';
    alert.classList.remove('show');
  } else {
    row.querySelector('.pf-btn.fail').classList.add('active');
    row.style.background = 'var(--fail-bg)';
    alert.classList.add('show');
  }
  const anyFail = state.personalBehavior.includes('נכשל');
  document.getElementById('failBannerA').classList.toggle('show', anyFail);
  updateProgress();
}

function renderScoreSection(containerId, items, sectionKey, sectionTitle, avgId, sectionClass) {
  const container = document.getElementById(containerId);
  const html = `
    <div class="score-section-title">${sectionTitle}</div>
    <div class="score-legend">
      <span class="legend-label">מפתח:</span>
      <span class="score-chip bad">4-5 כשלון</span>
      <span class="score-chip borderline">6 כשלון</span>
      <span class="score-chip borderline">7 גבולי</span>
      <span class="score-chip good">8-9 טוב</span>
      <span class="score-chip excellent">10 מצוין</span>
      <span class="score-chip na">לא רלוונטי</span>
    </div>
    ${items.map((item, i) => `
      <div class="score-row" id="scoreRow_${sectionKey}_${i}">
        <div class="score-row-top">
          <span class="score-row-num">${i+1}.</span>
          <span class="score-row-text">${item}</span>
        </div>
        <div class="improvement-note" id="impNote_${sectionKey}_${i}">⚠ שימי לב שתהיה הלימה בין הציון לבין המשוב המילולי — סעיף זה הוגדר כנקודה לשיפור</div>
        <div class="score-buttons">
          ${SCORES.map(s => `
            <button class="score-btn ${s.cls}"
              onclick="setScore('${sectionKey}', ${i}, ${s.value}, this)"
              title="${s.label}">${s.label}</button>
          `).join('')}
        </div>
      </div>
    `).join('')}
    <div class="section-average ${sectionClass}">
      <div class="avg-label">ממוצע קטגוריה זו</div>
      <div class="avg-value" id="${avgId}">—<small> / 100</small></div>
    </div>
    <div class="comments-section">
      <label>הערות ודוגמאות:</label>
      <textarea id="comments_${sectionKey}" placeholder="נמקו ציונים נמוכים ותנו דוגמאות..."></textarea>
    </div>
  `;
  container.innerHTML = html;
}

function setScore(sectionKey, index, value, btn) {
  const map = { b1: 'b1', b2: 'b2', c: 'c', d: 'd' };
  state[map[sectionKey]][index] = value;

  const row = document.getElementById(`scoreRow_${sectionKey}_${index}`);
  row.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const note = document.getElementById(`impNote_${sectionKey}_${index}`);
  note.classList.toggle('show', value <= 7 && value !== 99);
  row.classList.toggle('improvement-item', value <= 7 && value !== 99);

  updateAverages();
  updateProgress();
}

function calcAvg(arr) {
  const valid = arr.filter(v => v !== null && v !== 99);
  if (valid.length === 0) return null;
  return valid.reduce((a,b)=>a+b,0) / valid.length * 10; // 0-100
}

function formatAvg(v) {
  if (v === null) return '—';
  return v.toFixed(1);
}

function updateAverages() {
  const a1 = calcAvg(state.b1);
  const a2 = calcAvg(state.b2);
  const a3 = calcAvg(state.c);
  const a4 = calcAvg(state.d);

  document.getElementById('avg_b1').innerHTML = `${formatAvg(a1)}<small> / 100</small>`;
  document.getElementById('avg_b2').innerHTML = `${formatAvg(a2)}<small> / 100</small>`;
  document.getElementById('avg_c').innerHTML  = `${formatAvg(a3)}<small> / 100</small>`;
  document.getElementById('avg_d').innerHTML  = `${formatAvg(a4)}<small> / 100</small>`;

  document.getElementById('avg1').textContent = formatAvg(a1);
  document.getElementById('avg2').textContent = formatAvg(a2);
  document.getElementById('avg3').textContent = formatAvg(a3);
  document.getElementById('avg4').textContent = formatAvg(a4);

  const avgs = [a1, a2, a3, a4].filter(v => v !== null);
  const finalEl = document.getElementById('finalScoreDisplay');
  const statusEl = document.getElementById('finalScoreStatus');

  if (avgs.length === 0) {
    finalEl.textContent = '—';
    statusEl.style.display = 'none';
    return;
  }

  const finalAvg = avgs.reduce((a,b)=>a+b,0) / avgs.length;
  finalEl.textContent = finalAvg.toFixed(1);

  const anyPersonalFail = state.personalBehavior.includes('נכשל');
  const passing = !anyPersonalFail && finalAvg >= 70;

  finalEl.className = `final-score-value ${passing ? 'pass' : 'fail'}`;
  statusEl.style.display = 'inline-block';
  statusEl.className = `final-score-status ${passing ? 'pass' : 'fail'}`;
  statusEl.textContent = passing ? '✓ עבר' : '✗ נכשל';
}

/**
 * =============================
 * PROGRESS
 * =============================
 */
function updateProgress() {
  let filled = 0, total = 0;

  total += 6;
  filled += state.personalBehavior.filter(v => v !== null).length;

  [state.b1, state.b2, state.c, state.d].forEach(arr => {
    total += arr.length;
    filled += arr.filter(v => v !== null).length;
  });

  const pct = Math.round((filled / total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
}

/**
 * =============================
 * VALIDATION
 * =============================
 */
function validateForm() {
  const missing = [];

  const unfilledPF = state.personalBehavior.map((v,i) => v === null ? i+1 : null).filter(v => v !== null);
  if (unfilledPF.length > 0) {
    missing.push(`סעיף א - התנהגות אישית: סעיפים ${unfilledPF.join(', ')} לא מולאו`);
  }

  const anyPersonalFail = state.personalBehavior.includes('נכשל');
  if (anyPersonalFail) {
    if (!document.getElementById('commentsA').value.trim()) {
      missing.push('סעיף א - יש למלא הערות ודוגמאות בעת כשלון');
    }
    return missing;
  }

  const sections = [
    { arr: state.b1, name: 'ב.1 אבחון' },
    { arr: state.b2, name: 'ב.2 תכנון' },
    { arr: state.c,  name: 'ג - תקשורת' },
    { arr: state.d,  name: 'ד - אישיות מקצועית' },
  ];

  sections.forEach(sec => {
    const unfilled = sec.arr.map((v,i) => v === null ? i+1 : null).filter(v => v !== null);
    if (unfilled.length > 0) missing.push(`${sec.name}: סעיפים ${unfilled.join(', ')} לא מולאו`);
  });

  if (!document.getElementById('finalSummary').value.trim()) missing.push('סיכום מילולי — שדה ריק');
  if (!document.getElementById('studentName').value.trim()) missing.push('שם הסטודנט/ית — שדה ריק');

  return missing;
}

/**
 * =============================
 * DOCX GENERATION (RTL/Right aligned enforced)
 * =============================
 */
async function generateDocx() {
  const getVal = id => document.getElementById(id)?.value || '';

  const scoreLabel = v => {
    if (v === null) return 'לא מולא';
    if (v === 99) return 'לא רלוונטי';
    return String(v === 4.5 ? '4-5' : v);
  };
  const pfLabel = v => v || 'לא מולא';

  const avgs = [calcAvg(state.b1), calcAvg(state.b2), calcAvg(state.c), calcAvg(state.d)];
  const validAvgs = avgs.filter(v => v !== null);
  const finalScore = validAvgs.length ? (validAvgs.reduce((a,b)=>a+b,0) / validAvgs.length).toFixed(1) : '—';

  function esc(s) {
    return String(s || '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  // IMPORTANT: enforce RTL + right alignment on paragraph level (w:bidi + w:jc right)
  function para(text, opts = {}) {
    const bold = opts.bold ? '<w:b/><w:bCs/>' : '';
    const size = opts.size || 22;
    const color = opts.color ? `<w:color w:val="${opts.color}"/>` : '';
    const heading = opts.heading || '';
    const pStyle = heading ? `<w:pStyle w:val="${heading}"/>` : '';
    const spacing = opts.spacing
      ? `<w:spacing w:before="${opts.spacing.before||0}" w:after="${opts.spacing.after||120}"/>`
      : '<w:spacing w:after="100"/>';

    return `<w:p>
      <w:pPr>
        ${pStyle}
        <w:bidi/>
        <w:jc w:val="right"/>
        ${spacing}
      </w:pPr>
      <w:r>
        <w:rPr>
          <w:rtl/>
          ${bold}
          <w:sz w:val="${size}"/><w:szCs w:val="${size}"/>
          ${color}
          <w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/>
        </w:rPr>
        <w:t xml:space="preserve">${esc(text)}</w:t>
      </w:r>
    </w:p>`;
  }

  function twoRunPara(label, val, valColor) {
    const colorXml = valColor ? `<w:color w:val="${valColor}"/>` : '';
    return `<w:p>
      <w:pPr><w:bidi/><w:jc w:val="right"/><w:spacing w:after="80"/></w:pPr>
      <w:r>
        <w:rPr><w:rtl/><w:b/><w:bCs/><w:sz w:val="22"/><w:szCs w:val="22"/><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/></w:rPr>
        <w:t xml:space="preserve">${esc(label)}: </w:t>
      </w:r>
      <w:r>
        <w:rPr><w:rtl/><w:sz w:val="22"/><w:szCs w:val="22"/>${colorXml}<w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/></w:rPr>
        <w:t>${esc(val || '—')}</w:t>
      </w:r>
    </w:p>`;
  }

  function h1(text) { return para(text, { heading: 'Heading1', bold: true, size: 28, spacing: { before: 240, after: 120 } }); }
  function h2(text) { return para(text, { heading: 'Heading2', bold: true, size: 24, spacing: { before: 200, after: 100 } }); }
  function blank() { return '<w:p><w:pPr><w:bidi/><w:jc w:val="right"/><w:spacing w:after="80"/></w:pPr></w:p>'; }

  let body = '';

  body += h1('הערכת הסטודנטית בלימודים הקליניים');
  body += blank();

  body += h2('פרטי ההכשרה');
  body += twoRunPara('שם הסטודנט/ית', getVal('studentName'));
  body += twoRunPara('מקום ההכשרה', getVal('trainingPlace'));
  body += twoRunPara('תחום ההכשרה', getVal('trainingField'));
  body += twoRunPara('מעסיק', getVal('employer'));
  body += twoRunPara('הכשרה בשנה', getVal('trainingYear'));
  body += twoRunPara('שנה"ל', getVal('academicYear'));
  body += twoRunPara('מתאריך', getVal('dateFrom'));
  body += twoRunPara('עד תאריך', getVal('dateTo'));
  body += twoRunPara('ימי היעדרות', getVal('absenceDays'));
  body += twoRunPara('סיבת היעדרות', getVal('absenceReason'));
  body += twoRunPara('נושאים', getVal('topics'));
  body += twoRunPara('קליניקה חוזרת', getVal('repeatClinic'));
  body += blank();

  body += h2('פרטי המדריך/ה');
  body += twoRunPara('שם המדריך/ה', getVal('supervisorName'));
  body += twoRunPara('ותק בהדרכה', getVal('supervisorExperience'));
  body += twoRunPara('תואר', getVal('supervisorDegree'));
  body += twoRunPara('קורס הדרכה', getVal('supervisorCourse'));
  body += blank();

  body += h2('א. התנהגות אישית');
  personalBehaviorItems.forEach((item, i) => {
    const val = state.personalBehavior[i];
    const color = val === 'נכשל' ? 'CC0000' : (val === 'עבר' ? '007700' : '888888');
    body += twoRunPara(`${i+1}. ${item}`, pfLabel(val), color);
  });
  body += para(`הערות: ${getVal('commentsA') || '—'}`);
  body += blank();

  body += h2('ב.1 אבחון — תהליך איתור הצרכים');
  sectionB1Items.forEach((item, i) => body += para(`${i+1}. ${item}: ${scoreLabel(state.b1[i])}`));
  body += para(`ממוצע: ${formatAvg(calcAvg(state.b1))} / 100`, { bold: true });
  const commB1 = getVal('comments_b1');
  if (commB1) body += para(`הערות: ${commB1}`);
  body += blank();

  body += h2('ב.2 תכנון הטיפול וביצועו');
  sectionB2Items.forEach((item, i) => body += para(`${i+1}. ${item}: ${scoreLabel(state.b2[i])}`));
  body += para(`ממוצע: ${formatAvg(calcAvg(state.b2))} / 100`, { bold: true });
  const commB2 = getVal('comments_b2');
  if (commB2) body += para(`הערות: ${commB2}`);
  body += blank();

  body += h2('ג. כישורים כלליים בתקשורת');
  sectionCItems.forEach((item, i) => body += para(`${i+1}. ${item}: ${scoreLabel(state.c[i])}`));
  body += para(`ממוצע: ${formatAvg(calcAvg(state.c))} / 100`, { bold: true });
  const commC = getVal('comments_c');
  if (commC) body += para(`הערות: ${commC}`);
  body += blank();

  body += h2('ד. גיבוש האישיות המקצועית');
  sectionDItems.forEach((item, i) => body += para(`${i+1}. ${item}: ${scoreLabel(state.d[i])}`));
  body += para(`ממוצע: ${formatAvg(calcAvg(state.d))} / 100`, { bold: true });
  const commD = getVal('comments_d');
  if (commD) body += para(`הערות: ${commD}`);
  body += blank();

  body += h2('סיכום');
  body += para(getVal('finalSummary') || '—');
  body += blank();

  const scoreColor = finalScore !== '—' && parseFloat(finalScore) >= 70 ? '007700' : 'CC0000';
  body += `<w:p>
    <w:pPr><w:bidi/><w:jc w:val="right"/><w:spacing w:after="100"/></w:pPr>
    <w:r><w:rPr><w:rtl/><w:b/><w:bCs/><w:sz w:val="28"/><w:szCs w:val="28"/><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/></w:rPr><w:t xml:space="preserve">ציון סופי: </w:t></w:r>
    <w:r><w:rPr><w:rtl/><w:b/><w:bCs/><w:sz w:val="32"/><w:szCs w:val="32"/><w:color w:val="${scoreColor}"/><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/></w:rPr><w:t>${esc(finalScore)}</w:t></w:r>
  </w:p>`;
  body += blank();
  body += twoRunPara('תאריך מילוי', getVal('evaluationDate'));
  body += twoRunPara('חתימה', getVal('signatureName'));

  // IMPORTANT: sectPr must be the LAST element in w:body for best Word behavior
  const documentXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
  xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"
  xmlns:v="urn:schemas-microsoft-com:vml"
  xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
  xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
  xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml"
  mc:Ignorable="w14">
  <w:body>
    ${body}
    <w:sectPr>
      <w:bidi/>
      <w:pgSz w:w="11906" w:h="16838"/>
      <w:pgMar w:top="720" w:right="720" w:bottom="720" w:left="720"/>
    </w:sectPr>
  </w:body>
</w:document>`;

  const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:docDefaults>
    <w:rPrDefault><w:rPr>
      <w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/>
      <w:sz w:val="22"/><w:szCs w:val="22"/>
      <w:rtl/>
    </w:rPr></w:rPrDefault>
  </w:docDefaults>
  <w:style w:type="paragraph" w:styleId="Heading1">
    <w:name w:val="heading 1"/>
    <w:pPr><w:bidi/><w:jc w:val="right"/><w:spacing w:before="240" w:after="120"/></w:pPr>
    <w:rPr><w:b/><w:bCs/><w:sz w:val="32"/><w:szCs w:val="32"/><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:rtl/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading2">
    <w:name w:val="heading 2"/>
    <w:pPr><w:bidi/><w:jc w:val="right"/><w:spacing w:before="200" w:after="100"/></w:pPr>
    <w:rPr><w:b/><w:bCs/><w:sz w:val="26"/><w:szCs w:val="26"/><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:rtl/></w:rPr>
  </w:style>
</w:styles>`;

  const settingsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:settings xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:themeFontLang w:bidi="he-IL"/>
  <w:bidi/>
</w:settings>`;

  const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/settings" Target="settings.xml"/>
</Relationships>`;

  const appRelsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

  const contentTypesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
  <Override PartName="/word/settings.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.settings+xml"/>
</Types>`;

  const zip = new JSZip();
  zip.file('[Content_Types].xml', contentTypesXml);
  zip.file('_rels/.rels', appRelsXml);
  zip.file('word/document.xml', documentXml);
  zip.file('word/styles.xml', stylesXml);
  zip.file('word/settings.xml', settingsXml);
  zip.file('word/_rels/document.xml.rels', relsXml);

  return await zip.generateAsync({
    type: 'blob',
    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  });
}

/**
 * =============================
 * Download helper
 * =============================
 */
function triggerDownload(blob, fileName) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

/**
 * =============================
 * REAL Google Drive upload (OAuth)
 * =============================
 */
let driveAccessToken = null;

function getDriveAccessToken() {
  return new Promise((resolve, reject) => {
    if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.includes('PASTE_YOUR')) {
      return reject(new Error('חסר GOOGLE_CLIENT_ID (OAuth). הדבק Client ID אמיתי בקוד.'));
    }
    if (driveAccessToken) return resolve(driveAccessToken);

    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/drive.file',
      callback: (resp) => {
        if (!resp || resp.error) return reject(new Error(resp?.error || 'No token'));
        driveAccessToken = resp.access_token;
        resolve(driveAccessToken);
      },
    });

    // prompt:'' -> לא מכריח לבחור חשבון כל פעם; אם אין סשן/הרשאה, גוגל יפתח חלון.
    tokenClient.requestAccessToken({ prompt: '' });
  });
}

async function uploadDocxToDrive(blob, fileName, folderId) {
  if (!folderId) throw new Error('חסר DRIVE_FOLDER_ID');

  const accessToken = await getDriveAccessToken();

  const metadata = {
    name: fileName,
    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    parents: [folderId],
  };

  const boundary = '-------314159265358979323846';
  const delimiter = `\r\n--${boundary}\r\n`;
  const closeDelim = `\r\n--${boundary}--`;

  const arrayBuffer = await blob.arrayBuffer();
  const docxBytes = new Uint8Array(arrayBuffer);

  const bodyParts = [];
  bodyParts.push(new TextEncoder().encode(
    delimiter +
    'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
    JSON.stringify(metadata) +
    delimiter +
    'Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document\r\n' +
    'Content-Transfer-Encoding: binary\r\n\r\n'
  ));
  bodyParts.push(docxBytes);
  bodyParts.push(new TextEncoder().encode(closeDelim));

  const multipartBody = new Blob(bodyParts, { type: `multipart/related; boundary=${boundary}` });

  const url = 'https://www.googleapis.com/upload/drive/v3/files'
    + '?uploadType=multipart'
    + '&supportsAllDrives=true'
    + '&fields=id,name,webViewLink';

  const res = await fetch(url, {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}` },
    body: multipartBody,
  });

  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    // הרבה פעמים אם אין הרשאת עריכה לתיקייה—תקבל 403
    throw new Error(`Drive upload failed (${res.status}). ${t}`);
  }

  return await res.json();
}

function openDriveFolder(folderId) {
  const url = `https://drive.google.com/drive/folders/${folderId}`;
  window.open(url, '_blank');
}

/**
 * =============================
 * Submit: download + upload + open folder
 * =============================
 */
async function handleSubmitAuto() {
  const errors = validateForm();
  if (errors.length > 0) {
    showToast('⚠️ הטופס אינו מלא:\n' + errors.map(e => '• ' + e).join('\n'), 'error');
    return;
  }

  const btn = document.getElementById('submitBtn');
  const orig = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> שולח...';

  try {
    const blob = await generateDocx();
    const studentName = (document.getElementById('studentName')?.value || 'הערכה').trim();
    const dateStr = new Date().toLocaleDateString('he-IL').replace(/\//g, '-');
    const fileName = `הערכת_סטודנט_${studentName}_${dateStr}.docx`;

    // 1) הורדה מקומית
    triggerDownload(blob, fileName);

    // 2) העלאה לדרייב (אמיתי)
    const uploaded = await uploadDocxToDrive(blob, fileName, DRIVE_FOLDER_ID);

    // 3) פתיחה אוטומטית לתיקייה
    openDriveFolder(DRIVE_FOLDER_ID);

    showToast(`✅ הועלה ל-Drive בהצלחה!\nשם קובץ: ${uploaded?.name || fileName}`, 'success');
  } catch (e) {
    console.error(e);
    showToast('❌ שגיאה בשליחה:\n' + (e?.message || e), 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = orig;
  }
}

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 4500);
}

/**
 * =============================
 * INIT
 * =============================
 */
function init() {
  renderPersonalBehavior();
  const bContainer = document.getElementById('sectionBContent');
  bContainer.innerHTML = `<div id="b1Container" style="margin-bottom: 28px;"></div><div id="b2Container"></div>`;
  renderScoreSection('b1Container', sectionB1Items, 'b1', '1. אבחון — תהליך איתור הצרכים', 'avg_b1', 'section-b');
  renderScoreSection('b2Container', sectionB2Items, 'b2', '2. תכנון הטיפול/פרויקט/התערבות וביצועו', 'avg_b2', 'section-b');
  renderScoreSection('sectionCContent', sectionCItems, 'c', 'כישורים כלליים בתקשורת', 'avg_c', 'section-c');
  renderScoreSection('sectionDContent', sectionDItems, 'd', 'גיבוש האישיות המקצועית', 'avg_d', 'section-d');
  updateProgress();
}
init();
</script>

</body>
</html>
