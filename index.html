<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×”×¢×¨×›×ª ×”×¡×˜×•×“× ×˜×™×ª ×‘×œ×™××•×“×™× ×”×§×œ×™× ×™×™×</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700;800;1000&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
<style>
  :root {
    --primary: #1a3a5c;
    --secondary: #2e6da4;
    --accent: #c8973a;
    --success: #2d7a4f;
    --danger: #b03030;
    --bg: #f5f3ef;
    --card: #ffffff;
    --border: #d4cfc8;
    --text: #1c1c1c;
    --muted: #6b6560;
    --hover: #eef4fb;
    --score-bg: #e8f0f8;
    --score-active: #1a3a5c;
    --score-text: #ffffff;
    --fail-bg: #fde8e8;
    --pass-bg: #e8f7ee;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg);
    color: var(--text);
    direction: rtl;
    min-height: 100vh;
  }

   /* Header */
  .header {
    background: var(--primary);
    color: white;
    padding: 28px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 4px solid var(--accent);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.3);
  }

  .header-title { font-size: 22px; font-weight: 800; letter-spacing: 0.5px; }
  .header-subtitle { font-size: 12px; opacity: 0.7; margin-top: 3px; }



  /* Progress */
  .progress-bar {
    background: rgba(255,255,255,0.2);
    height: 4px;
    position: absolute;
    bottom: 0; right: 0; left: 0;
  }
  .progress-fill {
    background: var(--accent);
    height: 100%;
    width: 0%;
    transition: width 0.5s ease;
  }

  /* Main layout */
  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 32px 20px 80px;
  }

  /* Cards */
  .card {
    background: var(--card);
    border-radius: 16px;
    border: 1px solid var(--border);
    margin-bottom: 24px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    transition: box-shadow 0.2s;
  }
  .card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

  .card-header {
    background: var(--primary);
    color: white;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .card-header.section-b { background: #1e5080; }
  .card-header.section-c { background: #1d5538; }
  .card-header.section-d { background: #5c3a1a; }
  .card-header.section-summary { background: #3a1a5c; }

  .card-header-num {
    width: 36px; height: 36px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; font-weight: 800;
    flex-shrink: 0;
  }

  .card-header-title { font-size: 17px; font-weight: 700; }
  .card-header-subtitle { font-size: 12px; opacity: 0.75; margin-top: 2px; }

  .card-body { padding: 24px; }

  /* Info notice */
  .info-box {
    background: #fffbf0;
    border: 1px solid #e8d48a;
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 20px;
    font-size: 13px;
    color: #6b5a1c;
    line-height: 1.6;
  }

  /* Form fields */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .form-grid.three { grid-template-columns: 1fr 1fr 1fr; }
  .form-grid.full { grid-template-columns: 1fr; }

  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 13px; font-weight: 600; color: var(--muted); }
  .field input, .field select, .field textarea {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    color: var(--text);
    background: white;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
    direction: rtl;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(46,109,164,0.12);
  }
  .field textarea { min-height: 80px; resize: vertical; }

  /* Pass/Fail selectors */
  .pass-fail-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 8px;
    border: 1.5px solid var(--border);
    background: white;
    gap: 16px;
    transition: background 0.2s;
  }
  .pass-fail-row:last-child { margin-bottom: 0; }

  .pass-fail-text {
    flex: 1;
    font-size: 14px;
    line-height: 1.5;
  }
  .pass-fail-num {
    font-weight: 700;
    color: var(--secondary);
    margin-left: 6px;
  }

  .pass-fail-controls {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  .pf-btn {
    padding: 6px 16px;
    border-radius: 20px;
    border: 2px solid transparent;
    font-family: 'Heebo', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    background: #f0f0f0;
    color: #666;
  }
  .pf-btn.pass { border-color: #b8e0c8; }
  .pf-btn.pass:hover { background: var(--pass-bg); color: var(--success); }
  .pf-btn.pass.active { background: var(--success); color: white; border-color: var(--success); }
  .pf-btn.fail { border-color: #f0c0c0; }
  .pf-btn.fail:hover { background: var(--fail-bg); color: var(--danger); }
  .pf-btn.fail.active { background: var(--danger); color: white; border-color: var(--danger); }

  .fail-alert {
    background: var(--fail-bg);
    border: 1px solid #e8a0a0;
    border-radius: 8px;
    padding: 10px 16px;
    margin-top: 8px;
    font-size: 13px;
    color: var(--danger);
    font-weight: 600;
    display: none;
  }
  .fail-alert.show { display: block; }

  .fail-banner {
    background: #b03030;
    color: white;
    border-radius: 10px;
    padding: 14px 20px;
    text-align: center;
    font-size: 15px;
    font-weight: 700;
    margin: 12px 0;
    display: none;
  }
  .fail-banner.show { display: block; }

  /* Score table */
  .score-section-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e8eef5;
  }

  .score-legend {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: #f0f4f8;
    border-radius: 10px;
    align-items: center;
  }
  .legend-label { font-size: 12px; color: var(--muted); font-weight: 600; margin-left: 6px; }
  .score-chip {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    background: var(--score-bg);
    color: var(--primary);
    cursor: default;
  }
  .score-chip.bad { background: #fde8e8; color: #b03030; }
  .score-chip.borderline { background: #fff3cd; color: #856404; }
  .score-chip.good { background: #d4edda; color: #155724; }
  .score-chip.excellent { background: #cce5ff; color: #004085; }
  .score-chip.na { background: #e2e3e5; color: #555; }

  /* Score rows â€” two-line layout: text on top, buttons on bottom */
  .score-row {
    display: flex;
    flex-direction: column;
    padding: 10px 14px;
    border-radius: 10px;
    margin-bottom: 8px;
    border: 1.5px solid var(--border);
    background: white;
    gap: 8px;
    transition: background 0.2s;
  }
  .score-row.improvement-item { border-color: #f0e0a0; background: #fffef5; }

  .score-row-top {
    display: flex;
    align-items: baseline;
    gap: 6px;
  }

  .score-row-text {
    flex: 1;
    font-size: 13.5px;
    line-height: 1.5;
  }
  .score-row-num {
    font-weight: 700;
    color: var(--secondary);
    font-size: 12px;
    flex-shrink: 0;
    min-width: 20px;
  }

  /* Buttons always in a single row using grid */
  .score-buttons {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 4px;
    width: 100%;
  }

  .score-btn {
    height: 36px;
    width: 100%;
    border-radius: 7px;
    border: 1.5px solid var(--border);
    font-family: 'Heebo', sans-serif;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
    background: white;
    color: var(--text);
    white-space: nowrap;
    padding: 0 2px;
  }
  .score-btn:hover { background: var(--hover); border-color: var(--secondary); }
  .score-btn.score-45 { font-size: 10px; }
  .score-btn.score-99 { font-size: 9.5px; background: #f0f0f0; color: #888; }
  .score-btn.active { background: var(--score-active); color: white; border-color: var(--score-active); }
  .score-btn.active.low { background: var(--danger); border-color: var(--danger); }
  .score-btn.active.borderline { background: #856404; border-color: #856404; }
  .score-btn.active.na { background: #666; border-color: #666; }

  .improvement-note {
    font-size: 11.5px;
    color: #856404;
    background: #fff3cd;
    border-radius: 6px;
    padding: 4px 8px;
    margin-top: 4px;
    display: none;
  }
  .improvement-note.show { display: block; }

  /* Section average */
  .section-average {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: linear-gradient(135deg, #1a3a5c 0%, #2e6da4 100%);
    border-radius: 10px;
    color: white;
    margin-top: 16px;
  }
  .section-average.section-b { background: linear-gradient(135deg, #1e5080 0%, #2e7db4 100%); }
  .section-average.section-c { background: linear-gradient(135deg, #1d5538 0%, #2d7a4f 100%); }
  .section-average.section-d { background: linear-gradient(135deg, #5c3a1a 0%, #8b5e2a 100%); }

  .avg-label { font-size: 14px; font-weight: 600; }
  .avg-value {
    font-size: 28px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .avg-value.fail-score { color: #ffaaaa; }
  .avg-value small { font-size: 14px; font-weight: 400; opacity: 0.8; }

  /* Comments area */
  .comments-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1.5px dashed var(--border);
  }
  .comments-section label {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    display: block;
    margin-bottom: 8px;
  }

  /* Final summary */
  .final-score-box {
    background: linear-gradient(135deg, #1a3a5c 0%, #2e3a5c 100%);
    border-radius: 14px;
    padding: 28px;
    color: white;
    text-align: center;
    margin-bottom: 20px;
  }
  .final-score-label { font-size: 16px; font-weight: 500; opacity: 0.85; margin-bottom: 8px; }
  .final-score-value { font-size: 64px; font-weight: 800; line-height: 1; }
  .final-score-value.pass { color: #7de89a; }
  .final-score-value.fail { color: #ff8888; }
  .final-score-status {
    margin-top: 10px;
    font-size: 18px;
    font-weight: 700;
    padding: 6px 20px;
    border-radius: 20px;
    display: inline-block;
  }
  .final-score-status.pass { background: rgba(125,232,154,0.2); color: #7de89a; }
  .final-score-status.fail { background: rgba(255,136,136,0.2); color: #ff8888; }

  .breakdown-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin: 16px 0;
  }
  .breakdown-item {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 12px;
    text-align: center;
  }
  .breakdown-item-label { font-size: 11px; opacity: 0.75; margin-bottom: 4px; }
  .breakdown-item-value { font-size: 22px; font-weight: 800; }

  /* Submit button */
  .submit-area {
    padding: 28px;
    background: white;
    border-radius: 16px;
    border: 1px solid var(--border);
    text-align: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }

  .submit-btn {
    background: linear-gradient(135deg, #1a3a5c, #2e6da4);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 16px 40px;
    font-family: 'Heebo', sans-serif;
    font-size: 17px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 16px rgba(26,58,92,0.4);
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }
  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(26,58,92,0.5);
  }
  .submit-btn:active { transform: translateY(0); }
  .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

  .submit-note {
    font-size: 12px;
    color: var(--muted);
    margin-top: 10px;
  }

  /* Google Drive modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    display: none;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: white;
    border-radius: 20px;
    padding: 36px;
    max-width: 480px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .modal-icon { font-size: 52px; margin-bottom: 16px; }
  .modal-title { font-size: 22px; font-weight: 800; color: var(--primary); margin-bottom: 10px; }
  .modal-subtitle { font-size: 14px; color: var(--muted); margin-bottom: 24px; line-height: 1.6; }

  .drive-note { display: none; }

  .modal-buttons { display: flex; gap: 12px; justify-content: center; flex-direction: column; }
  .modal-btn {
    padding: 12px 28px;
    border-radius: 10px;
    border: none;
    font-family: 'Heebo', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
  }
  .modal-btn.primary { background: #4285f4; color: white; box-shadow: 0 3px 12px rgba(66,133,244,0.4); }
  .modal-btn.primary:hover { background: #3367d6; transform: translateY(-1px); }
  .modal-btn.secondary { background: white; color: var(--text); border: 1.5px solid var(--border); }
  .modal-btn.secondary:hover { background: var(--bg); }
  .modal-btn.download { background: linear-gradient(135deg, var(--success), #3a9e6a); color: white; box-shadow: 0 3px 12px rgba(45,122,79,0.4); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: #1a3a5c;
    color: white;
    padding: 14px 20px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 9999;
    max-width: 350px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }

  /* Spinner */
  .spinner {
    width: 20px; height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 680px) {
    .form-grid { grid-template-columns: 1fr; }
    .form-grid.three { grid-template-columns: 1fr 1fr; }
    .score-buttons { grid-template-columns: repeat(5, 1fr); }
    .breakdown-grid { grid-template-columns: repeat(2, 1fr); }
    .header { padding: 18px 20px; }
    .card-body { padding: 16px; }
  }
</style>
</head>
<body>

<header class="header">
  <div>
    <div class="header-title">×”×¢×¨×›×ª ×”×¡×˜×•×“× ×˜×™×ª ×‘×œ×™××•×“×™× ×”×§×œ×™× ×™×™×</div>
    <div class="header-subtitle">×¨×™×¤×•×™ ×‘×¢×™×¡×•×§ â€” ×˜×•×¤×¡ ×”×¢×¨×›×” ××§×¦×•×¢×™</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>
</header>

<div class="container">

  <!-- ×¤×¨×˜×™ ×”×”×›×©×¨×” -->
  <div class="card" id="cardDetails">
    <div class="card-header">
      <div class="card-header-num">×¤</div>
      <div>
        <div class="card-header-title">×¤×¨×˜×™ ×”×”×›×©×¨×” ×•×¤×¨×˜×™ ×”××“×¨×™×š/×”</div>
        <div class="card-header-subtitle">××œ××• ××ª ×›×œ ×”×¤×¨×˜×™× ×”× ×“×¨×©×™×</div>
      </div>
    </div>
    <div class="card-body">
      <div class="form-grid">
        <div class="field">
          <label>×©× ×”×¡×˜×•×“× ×˜/×™×ª</label>
          <input type="text" id="studentName" placeholder="×©× ××œ×">
        </div>
        <div class="field">
          <label>××§×•× ×”×”×›×©×¨×” (×›×•×œ×œ ××§×•× ×‘××¨×¥)</label>
          <input type="text" id="trainingPlace" placeholder="×©× ×”××•×¡×“ ×•×™×©×•×‘">
        </div>
        <div class="field">
          <label>×ª×—×•× ×”×”×›×©×¨×”</label>
          <select id="trainingField">
            <option value="">×‘×—×¨×•...</option>
            <option>×™×œ×“×™×</option>
            <option>×§×”×™×œ×”</option>
            <option>×‘×¨×™××•×ª ×”× ×¤×©</option>
            <option>×¤×™×–×™×§×œ×™</option>
            <option>×’×¨×™××˜×¨×™</option>
          </select>
        </div>
        <div class="field">
          <label>××¢×¡×™×§</label>
          <select id="employer">
            <option value="">×‘×—×¨×•...</option>
            <option>××—×¨</option>
            <option>×©×™×¨×•×ª×™ ×‘×¨×™××•×ª ×›×œ×œ×™×ª</option>
            <option>××›×‘×™ ×©×™×¨×•×ª×™ ×‘×¨×™××•×ª</option>
            <option>×§×•×¤"×— ×××•×—×“×ª</option>
            <option>××©×¨×“ ×”×‘×¨×™××•×ª</option>
            <option>××©×¨×“ ×”×—×™× ×•×š</option>
            <option>×¨×•×•×—×”</option>
          </select>
        </div>
        <div class="field">
          <label>×”×›×©×¨×” ×‘×©× ×”</label>
          <select id="trainingYear">
            <option value="">×‘×—×¨×•...</option>
            <option>×‘</option><option>×’</option><option>×“</option>
          </select>
        </div>
        <div class="field">
          <label>×©× ×”"×œ</label>
          <select id="academicYear">
            <option value="">×‘×—×¨×•...</option>
            <option>×ª×©×¤"×“</option><option>×ª×©×¤"×”</option><option>×ª×©×¤"×•</option>
            <option>×ª×©×¤"×–</option><option>×ª×©×¤"×—</option><option>×ª×©×¤"×˜</option>
          </select>
        </div>
        <div class="field">
          <label>×”×—×œ ××ª××¨×™×š</label>
          <input type="date" id="dateFrom">
        </div>
        <div class="field">
          <label>×¢×“ ×ª××¨×™×š</label>
          <input type="date" id="dateTo">
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×™××™ ×”×¢×“×¨×•×ª</label>
          <input type="number" id="absenceDays" min="0" placeholder="0">
        </div>
        <div class="field">
          <label>×¡×™×‘×ª ×”×”×™×¢×“×¨×•×ª</label>
          <input type="text" id="absenceReason" placeholder="×× ×¨×œ×•×•× ×˜×™">
        </div>
        <div class="field">
          <label>×”× ×•×©××™× ×‘×”× ×”×ª××§×“ ×”×¡×˜×•×“× ×˜</label>
          <input type="text" id="topics" placeholder="×¤×¨×˜×•">
        </div>
        <div class="field">
          <label>×§×œ×™× ×™×§×” ×—×•×–×¨×ª</label>
          <select id="repeatClinic">
            <option value="">×‘×—×¨×•...</option>
            <option>×›×Ÿ</option><option>×œ×</option>
          </select>
        </div>
      </div>
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1.5px dashed var(--border);">
        <div class="form-grid">
          <div class="field">
            <label>×©× ×”××“×¨×™×š/×”</label>
            <input type="text" id="supervisorName" placeholder="×©× ××œ×">
          </div>
          <div class="field">
            <label>×•×ª×§ ×‘×”×“×¨×›×”</label>
            <input type="text" id="supervisorExperience" placeholder="×©× ×™×">
          </div>
          <div class="field">
            <label>×ª×•××¨</label>
            <select id="supervisorDegree">
              <option value="">×‘×—×¨×•...</option>
              <option>B.OT</option><option>M.OT</option><option>×“×•×§×˜×•×¨×˜</option>
            </select>
          </div>
          <div class="field">
            <label>×§×•×¨×¡ ×”×“×¨×›×”</label>
            <select id="supervisorCourse">
              <option value="">×‘×—×¨×•...</option>
              <option>×›×Ÿ</option><option>×œ×</option>
            </select>
          </div>
          <div class="field">
            <label>×”×™×›×Ÿ × ×¢×©×” ×”×§×•×¨×¡</label>
            <input type="text" id="coursePlace" placeholder="×× ×¨×œ×•×•× ×˜×™">
          </div>
        </div>
      </div>
      <!-- Staff only fields -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1.5px dashed var(--border);">
        <div style="font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 14px;">â­ ×œ××™×œ×•×™ ×¢×œ-×™×“×™ ×¦×•×•×ª ×”×”×“×¨×›×” ×”×§×œ×™× ×™×ª</div>
        <div class="form-grid three">
          <div class="field">
            <label>×”×ª×—×™×œ ×œ×™××•×“×™× ×‘×©× ×”"×œ</label>
            <select id="startYear">
              <option value="">×‘×—×¨×•...</option>
              <option>×¨××©×•×Ÿ</option><option>×©× ×™</option><option>×©×œ×™×©×™</option>
            </select>
          </div>
          <div class="field">
            <label>×”×’×™×© ×‘×§×©×” ××™×•×—×“×ª</label>
            <select id="specialRequest">
              <option value="">×‘×—×¨×•...</option>
              <option>×›×Ÿ</option><option>×œ×</option>
            </select>
          </div>
          <div class="field">
            <label>×§×™×‘×œ ×‘×§×©×” ××™×•×—×“×ª</label>
            <select id="specialRequestApproved">
              <option value="">×‘×—×¨×•...</option>
              <option>×›×Ÿ</option><option>×œ×</option>
            </select>
          </div>
          <div class="field">
            <label>×§×™×‘×œ ×‘×™×§×•×¨</label>
            <select id="visitReceived">
              <option value="">×‘×—×¨×•...</option>
              <option>×›×Ÿ</option><option>×œ×</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 2;">
            <label>×”×¢×¨×•×ª (×¦×•×•×ª ×”×“×¨×›×”)</label>
            <input type="text" id="staffNotes" placeholder="×”×¢×¨×•×ª">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ×”×•×¨××•×ª -->
  <div class="info-box">
    <strong>×”×•×¨××•×ª ×œ××™×œ×•×™:</strong><br>
    â€¢ ×”×˜×•×¤×¡ ×™××•×œ× ×‘×¡×™×•× ×”×”×ª× ×¡×•×ª ×”×§×œ×™× ×™×ª, ×©×œ× ×‘× ×•×›×—×•×ª ×”×¡×˜×•×“× ×˜×™×ª.<br>
    â€¢ ×™×© ×œ× ××§ ×”×—×œ×˜×•×ª ×‘×©×•×¨×ª ×”×”×¢×¨×•×ª (×—×•×‘×” ×× ×”×¡×˜×•×“× ×˜×™×ª ×œ× ×¢×‘×¨×” ××• ×‘×¦×™×•×Ÿ 7 ×•××˜×”).<br>
    â€¢ <strong>×ª× ××™ ××¢×‘×¨:</strong> ×. ×¦×™×•×Ÿ ×¢×•×‘×¨ ×‘×¤×¨×§ "×”×ª× ×”×’×•×ª ××™×©×™×ª" + ×‘. ×××•×¦×¢ ×›×œ×œ×™ 70 ×œ×¤×—×•×ª.<br>
    â€¢ ×¦×™×•×Ÿ 6 ×•××˜×” = ×›×©×œ×•×Ÿ ×‘×”×™×’×“ | ×¦×™×•×Ÿ 7 = ×ª×¤×§×•×“ ×’×‘×•×œ×™ | ×¦×™×•×Ÿ 10 = ××¦×•×™×™×Ÿ ×‘×”×¨×‘×” ××¢×‘×¨ ×œ× ×“×¨×©<br>
    â€¢ "×œ× ×¨×œ×•×•× ×˜×™" â€” ×›××©×¨ ×”×¡×¢×™×£ ×œ× × ×“×¨×© ×‘×©×œ×‘ ×–×” ××• ×œ× ××ª××™× ×œ××¡×’×¨×ª.
  </div>

  <!-- ×. ×”×ª× ×”×’×•×ª ××™×©×™×ª -->
  <div class="card" id="cardSectionA">
    <div class="card-header">
      <div class="card-header-num">×</div>
      <div>
        <div class="card-header-title">×. ×”×ª× ×”×’×•×ª ××™×©×™×ª</div>
        <div class="card-header-subtitle">×¡×˜×•×“× ×˜×™×ª ×©×œ× ×¢×‘×¨×” ××—×“ ××”×¡×¢×™×¤×™× 1-6, ×œ× ×¢×‘×¨×” ××ª ×›×œ ×”×”×ª× ×¡×•×ª ×”×§×œ×™× ×™×ª</div>
      </div>
    </div>
    <div class="card-body">
      <div id="personalBehaviorItems"></div>
      <div class="fail-banner" id="failBannerA">âš  ×”×¡×˜×•×“× ×˜/×™×ª × ×›×©×œ/×” ×‘×”×›×©×¨×” â€” ××™×Ÿ ×××©×™×›×™× ×œ××œ× ××ª ×”×¦×™×•× ×™×</div>
      <div class="comments-section">
        <label>×”×¢×¨×•×ª ×•×“×•×’×××•×ª:</label>
        <textarea id="commentsA" placeholder="× ××§×• ××ª ×”×—×œ×˜×ª×›× â€” ×—×•×‘×” ×× ×”×¡×˜×•×“× ×˜×™×ª × ×›×©×œ×”..."></textarea>
      </div>
    </div>
  </div>

  <!-- ×‘. ×™×›×•×œ×•×ª ×•×›×™×©×•×¨×™× -->
  <div class="card" id="cardSectionB">
    <div class="card-header section-b">
      <div class="card-header-num">×‘</div>
      <div>
        <div class="card-header-title">×‘. ×™×›×•×œ×•×ª ×•×›×™×©×•×¨×™× ×”× ×“×¨×©×™× ×œ×ª×›× ×•×Ÿ ×•×‘×™×¦×•×¢ ×ª×”×œ×™×š ×”×˜×™×¤×•×œ</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionBContent"></div>
    </div>
  </div>

  <!-- ×’. ×ª×§×©×•×¨×ª -->
  <div class="card" id="cardSectionC">
    <div class="card-header section-c">
      <div class="card-header-num">×’</div>
      <div>
        <div class="card-header-title">×’. ×›×™×©×•×¨×™× ×›×œ×œ×™×™× ×‘×ª×§×©×•×¨×ª</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionCContent"></div>
    </div>
  </div>

  <!-- ×“. ××™×©×™×•×ª ××§×¦×•×¢×™×ª -->
  <div class="card" id="cardSectionD">
    <div class="card-header section-d">
      <div class="card-header-num">×“</div>
      <div>
        <div class="card-header-title">×“. ×’×™×‘×•×© ×”××™×©×™×•×ª ×”××§×¦×•×¢×™×ª</div>
      </div>
    </div>
    <div class="card-body">
      <div id="sectionDContent"></div>
    </div>
  </div>

  <!-- ×¡×™×›×•× -->
  <div class="card" id="cardSummary">
    <div class="card-header section-summary">
      <div class="card-header-num">âœ“</div>
      <div>
        <div class="card-header-title">×¡×™×›×•× ×”×ª×¨×©××•×ª ××”×¡×˜×•×“× ×˜×™×ª</div>
        <div class="card-header-subtitle">×××•×œ× ×‘×¡×™×•× ×”×”×ª× ×¡×•×ª ×”×§×œ×™× ×™×ª</div>
      </div>
    </div>
    <div class="card-body">
      <div class="info-box">×™×© ×œ×¦×™×™×Ÿ × ×§×•×“×•×ª ×œ×©×™××•×¨ ×•×œ×©×™×¤×•×¨. ×™×© ×œ×”×ª×™×™×—×¡ ×‘×¦×•×¨×” ××¤×•×¨×©×ª ×œ×¡×¢×™×¤×™× ×‘×”× × ×™×ª×Ÿ ×¦×™×•×Ÿ 7 ×•××˜×”.</div>
      <div class="field">
        <label>×¡×™×›×•× ××™×œ×•×œ×™ ××¤×•×¨×˜:</label>
        <textarea id="finalSummary" placeholder="×›×ª×‘×• ×¡×™×›×•× ××¤×•×¨×˜ ×”×›×•×œ×œ × ×§×•×“×•×ª ×œ×©×™××•×¨ ×•×œ×©×™×¤×•×¨..." style="min-height: 140px;"></textarea>
      </div>
      <br>
      <div class="final-score-box" id="finalScoreBox">
        <div class="final-score-label">×¦×™×•×Ÿ ×¡×•×¤×™ (×××•×¦×¢ ×¦×™×•× ×™× ×©×œ ×›×œ ×”×˜×‘×œ××•×ª, ××—×•×©×‘ ××•×˜×•××˜×™×ª)</div>
        <div class="final-score-value" id="finalScoreDisplay">â€”</div>
        <div class="final-score-status" id="finalScoreStatus" style="display:none"></div>
        <div class="breakdown-grid">
          <div class="breakdown-item">
            <div class="breakdown-item-label">1. ××‘×—×•×Ÿ</div>
            <div class="breakdown-item-value" id="avg1">â€”</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">2. ×ª×›× ×•×Ÿ</div>
            <div class="breakdown-item-value" id="avg2">â€”</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">×’. ×ª×§×©×•×¨×ª</div>
            <div class="breakdown-item-value" id="avg3">â€”</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-item-label">×“. ××™×©×™×•×ª</div>
            <div class="breakdown-item-value" id="avg4">â€”</div>
          </div>
        </div>
      </div>
      <div class="form-grid" style="margin-top: 20px;">
        <div class="field">
          <label>×ª××¨×™×š ××™×œ×•×™ ×”×¢×¨×›×” ×¡×•×¤×™×ª</label>
          <input type="date" id="evaluationDate">
        </div>
        <div class="field">
          <label>×—×ª×™××” / ×©× ×”××“×¨×™×š/×”</label>
          <input type="text" id="signatureName" placeholder="×©× ××œ× ×œ××™×©×•×¨">
        </div>
      </div>
    </div>
  </div>

  <!-- Submit -->
  <div class="submit-area">
    <button class="submit-btn" id="submitBtn" onclick="handleSubmit()">
      <span>âœ“</span>
      ××©×¨×™ ×•×©×œ×—×™
    </button>
    <div class="submit-note">×”×˜×•×¤×¡ ×™×•××¨ ×œ×§×•×‘×¥ Word ×•×™×©×œ×— ×œ×’×•×’×œ ×“×¨×™×™×‘</div>
  </div>

</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-icon" id="modalIcon">ğŸ“¤</div>
    <div class="modal-title" id="modalTitle">×©×œ×™×—×” ×œ×’×•×’×œ ×“×¨×™×™×‘</div>
    <div class="modal-subtitle" id="modalSubtitle">×”×˜×•×¤×¡ ×™×•××¨ ×œ×§×•×‘×¥ Word ×•×™×™×©×œ×— ×œ×ª×™×§×™×™×ª ×¨×™×¤×•×™ ×‘×¢×™×¡×•×§</div>
    <div class="modal-buttons" id="modalButtons">
      <button class="modal-btn primary" onclick="sendToDrive()">ğŸ“¤ ×©×œ×— ×œ×’×•×’×œ ×“×¨×™×™×‘ ×©×œ tauotclinics</button>
      <button class="modal-btn download" onclick="downloadDocx()">â¬‡ ×”×•×¨×“ ×›×§×•×‘×¥ Word ×‘×œ×‘×“</button>
      <button class="modal-btn secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// =============== DATA ===============
const personalBehaviorItems = [
  '×œ×•×§×—×ª ××—×¨×™×•×ª ×¢×œ ××¢×©×™×” ×ª×•×š ×”×›×¨×ª ×’×‘×•×œ×•×ª ××™×©×™×™× ×•××§×¦×•×¢×™×™×',
  '××§×‘×œ×ª ××©×•×‘ ×•××©× ×” ×”×ª× ×”×’×•×ª ×‘×”×ª××',
  '××¤×’×™× ×” ×”×ª× ×”×’×•×ª ×”×•×œ××ª ×‘×§×©×¨×™×” ×¢× ××˜×•×¤×œ×™×, ×××•× ×™× ×•×× ×©×™ ××§×¦×•×¢ ××—×¨×™×',
  '×¤×•×¢×œ×ª ×ª×•×š ×©××™×¨×” ×¢×œ ×”×§×•×“ ×”××ª×™ ×•×–×›×•×™×•×ª ×”××˜×•×¤×œ',
  '××“×•×•×—×ª ×¢×œ ×˜×¢×•×™×•×ª ×‘×›×— ×•×‘×¤×•×¢×œ',
  '×©×•××¨×ª ×¢×œ ×‘×˜×™×—×•×ª ×”××˜×•×¤×œ ×©×œ×” ×‘×›×œ ×”×ª×—×•××™×'
];

const sectionB1Items = [
  '××•×¡×¤×ª ××™×“×¢ ××§×™×£ ×•××“×•×™×§ ×œ×’×‘×™ ×”×œ×§×•×—×•×ª ×¢×œ ×™×“×™ ×¢×¨×™×›×ª ×ª×¦×¤×™×•×ª ×•× ×™×ª×•×—×Ÿ.',
  '××•×¡×¤×ª ××™×“×¢ ×™×©×™×¨ ×¢×œ ×™×“×™ ×¨××™×•×Ÿ ×¢× ×”×œ×§×•×—, ×‘× ×™ ××©×¤×—×” ×•××˜×¤×œ×™× × ×•×¡×¤×™×.',
  '××•×¡×¤×ª ××™×“×¢ ×××§×•×¨×•×ª ×›×ª×•×‘×™×: ×”×¤× ×™×•×ª, ×ª×™×§ ×¨×¤×•××™, ×¡×¤×¨×•×ª ××§×¦×•×¢×™×ª',
  '××•×¡×¤×ª ××™×“×¢ ××”×¢×¨×›×•×ª ×•××‘×—×•× ×™× ×¤×•×¨××œ×™×™×',
  '××•×¡×¤×ª ××™×“×¢ ×¢×œ ×ª×—×•××™ ×ª×¤×§×•×“ ×¨×œ×‘× ×˜×™×™×',
  '××–×”×” ×¢×•×¦××•×ª ×•×—×•×œ×©×•×ª ×©×œ ×”×œ×§×•×—×•×ª ×œ×¤×™ ×”××™×“×¢ ×©×‘×™×“×™×”.',
  '××–×”×” ×¦×¨×›×™ ×”×œ×§×•×—/××“×/××•×›×œ×•×¡×™×™×ª ×”×™×¢×“ ×•××¢×œ×” ×¤×ª×¨×•× ×•×ª ××¤×©×¨×™×™×.',
  '××–×”×” ×¢×•×¦××•×ª ×•×—×•×œ×©×•×ª ×©×œ ×”×œ×§×•×—/×”×ª×¢×¨×‘×•×ª/×”×¤×¨×•×™×™×§×˜'
];

const sectionB2Items = [
  '×§×•×‘×¢×ª ××˜×¨×•×ª ×œ×œ×§×•×—/×¤×¨×•×™×§×˜/×”×ª×¢×¨×‘×•×ª ××™×•×¢×“×ª ×‘×”×ª×× ×œ××¡×§× ×•×ª ×©×”×•×¡×§×• ××ª×”×œ×™×š ××™×¡×•×£ ×”××™×“×¢ ×”××§×•×‘×œ ×‘××§×•×.',
  '×§×•×‘×¢×ª ×¡×“×¨×™ ×¢×“×™×¤×•×™×•×ª ×©×œ ××˜×¨×•×ª ×”×˜×™×¤×•×œ/×¤×¨×•×™×§×˜/×”×ª×¢×¨×‘×•×ª: ×œ×¤×™ ×¦×¨×›×™ ×”×œ×§×•×— ×•××¦×™××•×ª ×—×™×™×•.',
  '××ª××™××” ×©×™×˜×•×ª ×˜×™×¤×•×œ ×œ×¦×•×¨×›×™ ×”×œ×§×•×—/×œ×§×•×—×•×ª: ×•×‘×”×ª×× ×œ×’×™×©×” ×”×ª×™××•×¨×˜×™×ª.',
  '×‘×•×—×¨×ª ×¤×¢×™×œ×•×™×•×ª ×•×××¦×¢×™× ×”××ª××™××™× ×œ×”×©×’×ª ××˜×¨×•×ª ×”×¤×¨×•×™×§×˜/×”×ª×¢×¨×‘×•×ª ×•××©××¢×•×ª×™×™× ×œ×œ×§×•×—.',
  '××–×”×” ××¦×‘×™× ×‘×¢×™×™×ª×™×™×, ×‘×•×—×¨ ×•××™×™×©× ×¤×ª×¨×•× ×•×ª ××ª××™××™×.',
  '××ª×›× × ×ª ×•××©× ×” ×ª×›× ×™×ª ×˜×™×¤×•×œ ×‘×”×ª×× ×œ×©×œ×‘×™ ×”×”×ª×§×“××•×ª ×”×¤×¨×•×™×§×˜/×”×ª×¢×¨×‘×•×ª',
  '× ×•×ª× ×ª ×”×¡×‘×¨ ×œ×œ×§×•×— ×•××©×ª×¤×ª ×‘××”×œ×š ×”×”×ª×¢×¨×‘×•×ª',
  '××ª×›× × ×ª ×•×××¨×’× ×ª ××ª ×”×–××Ÿ ×‘×”×ª×× ×œ×¦×¨×›×™ ×”×˜×™×¤×•×œ/×”×ª×¢×¨×‘×•×ª/×¤×¨×•×™×§×˜',
  '××›×™× ×” ××ª ×”×œ×§×•×—/×•×ª ×œ×¡×™×•× ×ª×”×œ×™×š ×”×˜×™×¤×•×œ.',
  '××“×¨×™×›×” ××ª ×”×œ×§×•×—/×•×ª ×•××©×¤×—×ª×• ×‘×”×ª×× ×œ×¦×•×¨×š.',
  '××ª×›× × ×ª ××¢×¨×š/×˜×™×¤×•×œ ×”×ª×¢×¨×‘×•×ª ×‘×§×”×™×œ×”.',
  '××¤×¢×™×œ×”/××‘×¦×¢×ª ×˜×™×¤×•×œ/×”×ª×¢×¨×‘×•×ª ×‘×§×”×™×œ×”.'
];

const sectionCItems = [
  '××§×™×™××ª ×§×©×¨ ××ª××™× ×¢× ×”××“×¨×™×›×”: ×××•×Ÿ ×”×“×“×™, ×¤×ª×™×—×•×ª, ×©×™×ª×•×£ ×‘×¨×’×©×•×ª, ×“×¢×•×ª ×•××—×©×‘×•×ª.',
  '××¤×ª×—×ª ×§×©×¨ ×˜×™×¤×•×œ×™ ×¢× ×”×œ×§×•×—×•×ª: ××›×‘×“, ××¢×•×¨×¨ ×××•×Ÿ, ××ª×¢× ×™×™×Ÿ, ××§×‘×œ, ×××¤×ª×™, ××¡×¨×˜×™×‘×™, ××ª×™×™×—×¡ ×œ×¦×¨×›×™× ××™× ×“×™×‘×™×“×•××œ×™×™×.',
  '××–×”×”, ××’×™×‘×” ×•××ª×™×™×—×¡×ª ×œ×›×œ ×¦×•×¨×•×ª ×”×ª×§×©×•×¨×ª â€” ×ª×§×©×•×¨×ª ××™×œ×•×œ×™×ª ×•×œ× ××™×œ×•×œ×™×ª.',
  '××ª×‘×˜××ª ×‘×›×ª×‘ ×•×‘×¢"×¤: ××“×•×•×—×ª ×œ×¦×•×•×ª, ××¢×‘×™×¨×” ××™×“×¢ ×•×”× ×—×™×•×ª ×œ×œ×§×•×—×•×ª ×‘××•×¤×Ÿ ×‘×¨×•×¨, ×‘×”×™×¨ ×•×¨×œ×‘× ×˜×™',
  '××§×¤×™×“×” ×¢×œ ×ª×™×¢×•×“: ××ª×¢×“×ª ××ª ×¤×¢×™×œ×•×ª×” ×‘××•×¤×Ÿ ×‘×”×™×¨, ×©×™×˜×ª×™ ×•××•×ª××.',
  '× ×•×˜×œ×ª ×—×œ×§ ×¤×¢×™×œ ×‘×¤×™×ª×•×— ×ª×§×©×•×¨×ª ×¢× ×”×’×•×¨××™× ×”××¢×•×¨×‘×™×: ××“×¨×™×›×”, ×¦×•×•×ª ×¨×™×¤×•×™ ×‘×¢×™×¡×•×§, ×¦×•×•×ª ×¨×‘-××§×¦×•×¢×™ ×•××˜×•×¤×œ×™×.',
  '××’×œ×” ×›×‘×•×“, ×¨×’×™×©×•×ª ×•×¤×ª×™×—×•×ª ×œ×”×‘×“×œ×™× ×ª×¨×‘×•×ª×™×™×'
];

const sectionDItems = [
  '×›×•×©×¨ ×”×¡×ª×’×œ×•×ª ×•×’××™×©×•×ª: ××¡×ª×’×œ×ª ×œ××¡×’×¨×ª ×”×§×”×™×œ×ª×™×ª, ×œ×× ×©×™ ×”×¦×•×•×ª, ×œ×©×™×˜×ª ×”×¢×‘×•×“×”, ×œ××“×¨×™×›×”.',
  '×œ××™×“×”: ×œ×•××“×ª ××ª×¦×¤×™×•×ª, ××”×ª× ×¡×•×™×•×ª ×•×××©×•×‘.',
  '××¦×™×’×” ×©××œ×•×ª ××ª××™××•×ª: ×©××œ×•×ª ×”× ×•×’×¢×•×ª ×œ×¢×™×§×¨, ×œ×’×™×©×”, ×œ×¨×¦×™×•× ×œ ×”×˜×™×¤×•×œ×™, ×‘×¢×™×ª×•×™ ×”××ª××™×.',
  '××›×™×¨×” ××ª ×¢×•×¦××•×ª×™×”/×—×•×œ×©×•×ª×™×”: ××•×“×¢×ª ×œ×¢×¦××”.',
  '××ª××•×“×“×ª ×¢× ××¦×‘×™ ×ª×¡×›×•×œ ××§×¦×•×¢×™×™×: ×§×©×™×™× ×©×¢×•×œ×™× ×‘××”×œ×š ×”×”×ª×¢×¨×‘×•×ª/×¤×¨×•×™×™×§×˜, ×ª×¡×›×•×œ ××™×—×¡×™× ×¢× ×× ×©×™ ×¦×•×•×ª, ××œ×§×•×—×•×ª.',
  '××’×“×™×¨×” ×’×‘×•×œ×•×ª ×‘×¨×•×¨×™× ×‘×™× ×” ×œ×‘×™×Ÿ ×”×œ×§×•×—: ×”×ª× ×”×’×•×ª ×¤×™×–×™×ª ×•/××• ×—×‘×¨×ª×™×ª.',
  '××’×œ×” ×™×•×–××”: ×§×¨×™××ª ×—×•××¨, ×”×¢×œ××ª ×©××œ×•×ª, ×¨×¢×™×•× ×•×ª ×•×”×¦×¢×•×ª. ××’×œ×” × ×›×•× ×•×ª ×œ×”×©×ª×ª×£ ×‘×¤×¢×™×œ×•×™×•×ª.',
  '××’×œ×” ×™×›×•×œ×ª ×¢×‘×•×“×” ×¢×¦×××™×ª',
  '××ª××•×“×“×ª ×¢× ×œ×§×•×—×•×ª ×‘×¢×œ×™ ××¤×™×•× ×™× ×©×•× ×™× ×•×‘××¦×‘×™× ××©×ª× ×™× ×•××©× ×” ×”×ª× ×”×’×•×ª×” ×‘×”×ª××',
  '××¡×™×™××ª ×§×©×¨ ×”×ª×¢×¨×‘×•×ª: ×ª×”×œ×™×›×™ ×¤×¨×™×“×”.',
  '×©×•××¨×ª ×¢×œ ×—×•×§×™ ×”××•×¡×¨ ×•×”××ª×™×§×” ×”××§×¦×•×¢×™×ª: ×©××™×¨×” ×¢×œ ×¡×•×“×™×•×ª, ×›×™×‘×•×“ ×”××˜×•×¤×œ.',
  '×××™× ×” ×•××—×¨××™×ª ×‘×¢×‘×•×“×ª×” ×•×“×™×•×•×—×™×”'
];

const SCORES = [
  { label: '4-5', value: 4.5, cls: 'score-45 low' },
  { label: '6',   value: 6,   cls: 'low' },
  { label: '7',   value: 7,   cls: 'borderline' },
  { label: '7.5', value: 7.5, cls: '' },
  { label: '8',   value: 8,   cls: '' },
  { label: '8.5', value: 8.5, cls: '' },
  { label: '9',   value: 9,   cls: '' },
  { label: '9.5', value: 9.5, cls: '' },
  { label: '10',  value: 10,  cls: '' },
  { label: '×œ× ×¨×œ×•×•× ×˜×™', value: 99, cls: 'score-99 na' }
];

// State
const state = {
  personalBehavior: new Array(6).fill(null),
  b1: new Array(sectionB1Items.length).fill(null),
  b2: new Array(sectionB2Items.length).fill(null),
  c: new Array(sectionCItems.length).fill(null),
  d: new Array(sectionDItems.length).fill(null),
  improvementFlags: { b1: [], b2: [], c: [], d: [] }
};

// =============== RENDER ===============
function renderPersonalBehavior() {
  const container = document.getElementById('personalBehaviorItems');
  container.innerHTML = personalBehaviorItems.map((item, i) => `
    <div class="pass-fail-row" id="pfRow${i}">
      <div class="pass-fail-text">
        <span class="pass-fail-num">${i+1}.</span>${item}
      </div>
      <div class="pass-fail-controls">
        <button class="pf-btn pass" onclick="setPersonalBehavior(${i}, '×¢×‘×¨')">×¢×‘×¨</button>
        <button class="pf-btn fail" onclick="setPersonalBehavior(${i}, '× ×›×©×œ')">× ×›×©×œ</button>
      </div>
    </div>
    <div class="fail-alert" id="failAlert${i}">×”×¡×˜×•×“× ×˜/×™×ª × ×›×©×œ/×” ×‘×”×›×©×¨×”.</div>
  `).join('');
}

function setPersonalBehavior(index, value) {
  state.personalBehavior[index] = value;
  const row = document.getElementById(`pfRow${index}`);
  const alert = document.getElementById(`failAlert${index}`);
  row.querySelectorAll('.pf-btn').forEach(b => b.classList.remove('active'));
  if (value === '×¢×‘×¨') {
    row.querySelector('.pf-btn.pass').classList.add('active');
    row.style.background = 'var(--pass-bg)';
    alert.classList.remove('show');
  } else {
    row.querySelector('.pf-btn.fail').classList.add('active');
    row.style.background = 'var(--fail-bg)';
    alert.classList.add('show');
  }
  const anyFail = state.personalBehavior.includes('× ×›×©×œ');
  document.getElementById('failBannerA').classList.toggle('show', anyFail);
  updateProgress();
}

function renderScoreSection(containerId, items, sectionKey, sectionTitle, avgId, sectionClass) {
  const container = document.getElementById(containerId);
  const html = `
    <div class="score-section-title">${sectionTitle}</div>
    <div class="score-legend">
      <span class="legend-label">××¤×ª×—:</span>
      <span class="score-chip bad">4-5 ×›×©×œ×•×Ÿ</span>
      <span class="score-chip borderline">6 ×›×©×œ×•×Ÿ</span>
      <span class="score-chip borderline">7 ×’×‘×•×œ×™</span>
      <span class="score-chip good">8-9 ×˜×•×‘</span>
      <span class="score-chip excellent">10 ××¦×•×™×Ÿ</span>
      <span class="score-chip na">×œ× ×¨×œ×•×•× ×˜×™</span>
    </div>
    ${items.map((item, i) => `
      <div class="score-row" id="scoreRow_${sectionKey}_${i}">
        <div class="score-row-top">
          <span class="score-row-num">${i+1}.</span>
          <span class="score-row-text">${item}</span>
        </div>
        <div class="improvement-note" id="impNote_${sectionKey}_${i}">âš  ×©×™××™ ×œ×‘ ×©×ª×”×™×” ×”×œ×™××” ×‘×™×Ÿ ×”×¦×™×•×Ÿ ×œ×‘×™×Ÿ ×”××©×•×‘ ×”××™×œ×•×œ×™ â€” ×¡×¢×™×£ ×–×” ×”×•×’×“×¨ ×›× ×§×•×“×” ×œ×©×™×¤×•×¨</div>
        <div class="score-buttons">
          ${SCORES.map(s => `
            <button class="score-btn ${s.cls}" 
              onclick="setScore('${sectionKey}', ${i}, ${s.value}, this)"
              title="${s.label}">${s.label}</button>
          `).join('')}
        </div>
      </div>
    `).join('')}
    <div class="section-average ${sectionClass}">
      <div class="avg-label">×××•×¦×¢ ×§×˜×’×•×¨×™×” ×–×•</div>
      <div class="avg-value" id="${avgId}">â€”<small> / 100</small></div>
    </div>
    <div class="comments-section">
      <label>×”×¢×¨×•×ª ×•×“×•×’×××•×ª:</label>
      <textarea id="comments_${sectionKey}" placeholder="× ××§×• ×¦×™×•× ×™× × ××•×›×™× ×•×ª× ×• ×“×•×’×××•×ª..."></textarea>
    </div>
  `;
  container.innerHTML = html;
}

function setScore(sectionKey, index, value, btn) {
  // Map sectionKey to state
  const map = { b1: 'b1', b2: 'b2', c: 'c', d: 'd' };
  state[map[sectionKey]][index] = value;

  // Update button visuals
  const row = document.getElementById(`scoreRow_${sectionKey}_${index}`);
  row.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  // Improvement note for 4-5, 6, 7
  const note = document.getElementById(`impNote_${sectionKey}_${index}`);
  note.classList.toggle('show', value <= 7 && value !== 99);

  // Update row styling
  row.classList.toggle('improvement-item', value <= 7 && value !== 99);

  updateAverages();
  updateProgress();
}

function calcAvg(arr) {
  const valid = arr.filter(v => v !== null && v !== 99);
  if (valid.length === 0) return null;
  return valid.reduce((a,b)=>a+b,0) / valid.length * 10; // scale to 0-100
}

function formatAvg(v) {
  if (v === null) return 'â€”';
  return v.toFixed(1);
}

function updateAverages() {
  const a1 = calcAvg(state.b1);
  const a2 = calcAvg(state.b2);
  const a3 = calcAvg(state.c);
  const a4 = calcAvg(state.d);

  document.getElementById('avg_b1').innerHTML = `${formatAvg(a1)}<small> / 100</small>`;
  document.getElementById('avg_b2').innerHTML = `${formatAvg(a2)}<small> / 100</small>`;
  document.getElementById('avg_c').innerHTML = `${formatAvg(a3)}<small> / 100</small>`;
  document.getElementById('avg_d').innerHTML = `${formatAvg(a4)}<small> / 100</small>`;

  document.getElementById('avg1').textContent = formatAvg(a1);
  document.getElementById('avg2').textContent = formatAvg(a2);
  document.getElementById('avg3').textContent = formatAvg(a3);
  document.getElementById('avg4').textContent = formatAvg(a4);

  const avgs = [a1, a2, a3, a4].filter(v => v !== null);
  const finalEl = document.getElementById('finalScoreDisplay');
  const statusEl = document.getElementById('finalScoreStatus');

  if (avgs.length === 0) {
    finalEl.textContent = 'â€”';
    statusEl.style.display = 'none';
    return;
  }

  const finalAvg = avgs.reduce((a,b)=>a+b,0) / avgs.length;
  finalEl.textContent = finalAvg.toFixed(1);

  const anyPersonalFail = state.personalBehavior.includes('× ×›×©×œ');
  const passing = !anyPersonalFail && finalAvg >= 70;

  finalEl.className = `final-score-value ${passing ? 'pass' : 'fail'}`;
  statusEl.style.display = 'inline-block';
  statusEl.className = `final-score-status ${passing ? 'pass' : 'fail'}`;
  statusEl.textContent = passing ? 'âœ“ ×¢×‘×¨' : 'âœ— × ×›×©×œ';
}

// =============== PROGRESS ===============
function updateProgress() {
  let filled = 0, total = 0;

  // Personal behavior
  total += 6;
  filled += state.personalBehavior.filter(v => v !== null).length;

  // Scores
  [state.b1, state.b2, state.c, state.d].forEach(arr => {
    total += arr.length;
    filled += arr.filter(v => v !== null).length;
  });

  const pct = Math.round((filled / total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
}

// =============== DOCX GENERATION ===============
async function generateDocx() {
  const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, BorderStyle, Table, TableRow, TableCell, WidthType } = docx;

  const getVal = id => document.getElementById(id)?.value || '';

  function heading(text, level = 2) {
    return new Paragraph({
      text, heading: level === 1 ? HeadingLevel.HEADING_1 : HeadingLevel.HEADING_2,
      alignment: AlignmentType.RIGHT,
      spacing: { before: 200, after: 100 }
    });
  }

  function line(label, val) {
    return new Paragraph({
      alignment: AlignmentType.RIGHT,
      spacing: { after: 80 },
      children: [
        new TextRun({ text: `${label}: `, bold: true, size: 24, font: 'Arial' }),
        new TextRun({ text: val || 'â€”', size: 24, font: 'Arial' })
      ]
    });
  }

  function sectionPara(text, bold = false) {
    return new Paragraph({
      alignment: AlignmentType.RIGHT,
      spacing: { after: 60 },
      children: [new TextRun({ text, bold, size: 22, font: 'Arial' })]
    });
  }

  const scoreLabel = v => {
    if (v === null) return '×œ× ××•×œ×';
    if (v === 99) return '×œ× ×¨×œ×•×•× ×˜×™';
    return String(v === 4.5 ? '4-5' : v);
  };

  const pfLabel = v => v || '×œ× ××•×œ×';

  const avgs = [
    calcAvg(state.b1), calcAvg(state.b2), calcAvg(state.c), calcAvg(state.d)
  ];
  const validAvgs = avgs.filter(v => v !== null);
  const finalScore = validAvgs.length ? (validAvgs.reduce((a,b)=>a+b,0) / validAvgs.length).toFixed(1) : 'â€”';

  const children = [
    heading('×”×¢×¨×›×ª ×”×¡×˜×•×“× ×˜×™×ª ×‘×œ×™××•×“×™× ×”×§×œ×™× ×™×™×', 1),
    new Paragraph({ text: '', spacing: { after: 100 } }),

    heading('×¤×¨×˜×™ ×”×”×›×©×¨×”'),
    line('×©× ×”×¡×˜×•×“× ×˜/×™×ª', getVal('studentName')),
    line('××§×•× ×”×”×›×©×¨×”', getVal('trainingPlace')),
    line('×ª×—×•× ×”×”×›×©×¨×”', getVal('trainingField')),
    line('××¢×¡×™×§', getVal('employer')),
    line('×”×›×©×¨×” ×‘×©× ×”', getVal('trainingYear')),
    line('×©× ×”"×œ', getVal('academicYear')),
    line('××ª××¨×™×š', getVal('dateFrom')),
    line('×¢×“ ×ª××¨×™×š', getVal('dateTo')),
    line('××¡×¤×¨ ×™××™ ×”×¢×“×¨×•×ª', getVal('absenceDays')),
    line('×¡×™×‘×ª ×”×”×™×¢×“×¨×•×ª', getVal('absenceReason')),
    line('× ×•×©××™×', getVal('topics')),
    line('×§×œ×™× ×™×§×” ×—×•×–×¨×ª', getVal('repeatClinic')),
    new Paragraph({ text: '', spacing: { after: 100 } }),

    heading('×¤×¨×˜×™ ×”××“×¨×™×š/×”'),
    line('×©× ×”××“×¨×™×š/×”', getVal('supervisorName')),
    line('×•×ª×§ ×‘×”×“×¨×›×”', getVal('supervisorExperience')),
    line('×ª×•××¨', getVal('supervisorDegree')),
    line('×§×•×¨×¡ ×”×“×¨×›×”', getVal('supervisorCourse')),
    new Paragraph({ text: '', spacing: { after: 100 } }),

    heading('×. ×”×ª× ×”×’×•×ª ××™×©×™×ª'),
    ...personalBehaviorItems.map((item, i) =>
      new Paragraph({
        alignment: AlignmentType.RIGHT,
        spacing: { after: 60 },
        children: [
          new TextRun({ text: `${i+1}. ${item}: `, size: 22, font: 'Arial' }),
          new TextRun({ text: pfLabel(state.personalBehavior[i]), bold: true, size: 22,
            color: state.personalBehavior[i] === '× ×›×©×œ' ? 'CC0000' : '007700', font: 'Arial' })
        ]
      })
    ),
    sectionPara(`×”×¢×¨×•×ª: ${getVal('commentsA') || 'â€”'}`),
    new Paragraph({ text: '', spacing: { after: 100 } }),

    heading('×‘.1 ××‘×—×•×Ÿ â€” ×ª×”×œ×™×š ××™×ª×•×¨ ×”×¦×¨×›×™×'),
    ...sectionB1Items.map((item, i) =>
      sectionPara(`${i+1}. ${item}: ${scoreLabel(state.b1[i])}`)
    ),
    sectionPara(`×××•×¦×¢: ${formatAvg(calcAvg(state.b1))} / 100`, true),
    new Paragraph({ text: '', spacing: { after: 100 } }),

    heading('×‘.2 ×ª×›× ×•×Ÿ ×”×˜×™×¤×•×œ ×•×‘×™×¦×•×¢×•'),
    ...sectionB2Items.map((item, i) =>
      sectionPara(`${i+1}. ${item}: ${scoreLabel(state.b2[i])}`)
    ),
    sectionPara(`×××•×¦×¢: ${formatAvg(calcAvg(state.b2))} / 100`, true),
    line('×”×¢×¨×•×ª ×¡×¢×™×£ ×‘', getVal('comments_b1') + ' ' + getVal('comments_b2')),
    new Paragraph({ text: '', spacing: { after: 100 } }),

    heading('×’. ×›×™×©×•×¨×™× ×›×œ×œ×™×™× ×‘×ª×§×©×•×¨×ª'),
    ...sectionCItems.map((item, i) =>
      sectionPara(`${i+1}. ${item}: ${scoreLabel(state.c[i])}`)
    ),
    sectionPara(`×××•×¦×¢: ${formatAvg(calcAvg(state.c))} / 100`, true),
    line('×”×¢×¨×•×ª', getVal('comments_c')),
    new Paragraph({ text: '', spacing: { after: 100 } }),

    heading('×“. ×’×™×‘×•×© ×”××™×©×™×•×ª ×”××§×¦×•×¢×™×ª'),
    ...sectionDItems.map((item, i) =>
      sectionPara(`${i+1}. ${item}: ${scoreLabel(state.d[i])}`)
    ),
    sectionPara(`×××•×¦×¢: ${formatAvg(calcAvg(state.d))} / 100`, true),
    line('×”×¢×¨×•×ª', getVal('comments_d')),
    new Paragraph({ text: '', spacing: { after: 120 } }),

    heading('×¡×™×›×•×'),
    new Paragraph({
      alignment: AlignmentType.RIGHT,
      spacing: { after: 80 },
      children: [new TextRun({ text: getVal('finalSummary') || 'â€”', size: 22, font: 'Arial' })]
    }),
    new Paragraph({ text: '', spacing: { after: 80 } }),
    new Paragraph({
      alignment: AlignmentType.RIGHT,
      children: [
        new TextRun({ text: '×¦×™×•×Ÿ ×¡×•×¤×™: ', bold: true, size: 28, font: 'Arial' }),
        new TextRun({ text: finalScore, bold: true, size: 32, font: 'Arial', color: finalScore !== 'â€”' && parseFloat(finalScore) >= 70 ? '007700' : 'CC0000' })
      ]
    }),
    new Paragraph({ text: '', spacing: { after: 80 } }),
    line('×ª××¨×™×š ××™×œ×•×™', getVal('evaluationDate')),
    line('×—×ª×™××”', getVal('signatureName')),
  ];

  const doc = new Document({
    sections: [{
      properties: { page: { margin: { top: 720, right: 720, bottom: 720, left: 720 } } },
      children
    }],
    styles: {
      default: {
        document: { run: { font: 'Arial', size: 22, rightToLeft: true } }
      }
    }
  });

  return await Packer.toBlob(doc);
}

// =============== SUBMIT ===============
function handleSubmit() {
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

async function downloadDocx() {
  try {
    showToast('××›×™×Ÿ ××ª ×”×§×•×‘×¥...', '');
    const blob = await generateDocx();
    const name = document.getElementById('studentName')?.value || '×”×¢×¨×›×”';
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `×”×¢×¨×›×ª_×¡×˜×•×“× ×˜_${name}.docx`;
    a.click();
    URL.revokeObjectURL(url);
    closeModal();
    showToast('âœ“ ×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”!', 'success');
  } catch(e) {
    showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×§×•×‘×¥: ' + e.message, 'error');
  }
}

// tauotclinics Google Drive folder â€” replace FOLDER_ID with the actual folder ID
// To get the ID: open the folder in Drive, copy the ID from the URL:
// https://drive.google.com/drive/folders/FOLDER_ID_HERE
const DRIVE_FOLDER_ID = 'FOLDER_ID_HERE'; // â† ×”×›× ×™×¡×• ×›××Ÿ ××ª ×”-ID ×©×œ ×”×ª×™×§×™×™×”

async function sendToDrive() {
  const btn = document.querySelector('#modalButtons .modal-btn.primary');
  const origText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner"></span> ××›×™×Ÿ...';
  btn.disabled = true;

  try {
    const blob = await generateDocx();
    const studentName = document.getElementById('studentName')?.value || '×”×¢×¨×›×”';
    const dateStr = new Date().toLocaleDateString('he-IL').replace(/\//g, '-');
    const fileName = `×”×¢×¨×›×ª_×¡×˜×•×“× ×˜_${studentName}_${dateStr}.docx`;

    // Download the file
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);

    // Open Drive folder of tauotclinics
    const driveFolderUrl = DRIVE_FOLDER_ID === 'FOLDER_ID_HERE'
      ? 'https://drive.google.com/drive/u/0/my-drive?authuser=tauotclinics@gmail.com'
      : `https://drive.google.com/drive/folders/${DRIVE_FOLDER_ID}?authuser=tauotclinics@gmail.com`;

    // Show success state
    document.getElementById('modalIcon').textContent = 'âœ…';
    document.getElementById('modalTitle').textContent = '×”×§×•×‘×¥ ××•×›×Ÿ!';
    document.getElementById('modalSubtitle').innerHTML = `
      ×”×§×•×‘×¥ <strong>${fileName}</strong> ×”×•×¨×“.<br><br>
      ×›×¢×ª ×¤×ª×—×• ××ª ×ª×™×§×™×™×ª Drive ×©×œ <strong>tauotclinics</strong> ×•×”×¢×œ×• ××ª ×”×§×•×‘×¥:
      <ol style="text-align:right; margin: 10px 0; font-size:13px; color:#555; line-height:1.9;">
        <li>×œ×—×¦×• "×¤×ª×— Drive" ×œ××˜×” â€” ×™×™×¤×ª×— ×‘-Google Drive ×©×œ tauotclinics</li>
        <li>×’×¨×¨×• ××ª ×”×§×•×‘×¥ ×©×”×•×¨×“ ×œ×ª×™×§×™×™×” <strong>××•</strong> ×œ×—×¦×• "+ ×—×“×©" â† "×”×¢×œ××ª ×§×•×‘×¥"</li>
      </ol>
    `;
    document.getElementById('modalButtons').innerHTML = `
      <a href="${driveFolderUrl}" target="_blank" class="modal-btn primary" style="text-decoration:none; display:inline-block; padding:12px 28px;">
        ğŸ“‚ ×¤×ª×— Drive ×©×œ tauotclinics
      </a>
      <button class="modal-btn secondary" onclick="closeModal()">×¡×’×•×¨</button>
    `;

  } catch(e) {
    showToast('×©×’×™××”: ' + e.message, 'error');
    btn.innerHTML = origText;
    btn.disabled = false;
  }
}

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3500);
}

// =============== INIT ===============
function init() {
  renderPersonalBehavior();

  // Section B sub-sections
  const bContainer = document.getElementById('sectionBContent');
  bContainer.innerHTML = `
    <div id="b1Container" style="margin-bottom: 28px;"></div>
    <div id="b2Container"></div>
  `;
  renderScoreSection('b1Container', sectionB1Items, 'b1', '1. ××‘×—×•×Ÿ â€” ×ª×”×œ×™×š ××™×ª×•×¨ ×”×¦×¨×›×™×', 'avg_b1', 'section-b');
  renderScoreSection('b2Container', sectionB2Items, 'b2', '2. ×ª×›× ×•×Ÿ ×”×˜×™×¤×•×œ/×¤×¨×•×™×§×˜/×”×ª×¢×¨×‘×•×ª ×•×‘×™×¦×•×¢×•', 'avg_b2', 'section-b');

  renderScoreSection('sectionCContent', sectionCItems, 'c', '×›×™×©×•×¨×™× ×›×œ×œ×™×™× ×‘×ª×§×©×•×¨×ª', 'avg_c', 'section-c');
  renderScoreSection('sectionDContent', sectionDItems, 'd', '×’×™×‘×•×© ×”××™×©×™×•×ª ×”××§×¦×•×¢×™×ª', 'avg_d', 'section-d');

  updateProgress();
}

init();
</script>
</body>
</html>
